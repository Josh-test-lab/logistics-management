---
title: "0528_v2"
output: html_document
date: "2025-05-28"
---

# 0528_v2

## 自動化讀取與處理普悠瑪客運資料

```{r message=FALSE}
library(readxl)
library(dplyr)
library(purrr)

start_time = Sys.time()  # 紀錄程式開始時間

# 設定年度與主目錄
base_path <- "C:/Users/user/OneDrive/Documents/運籌報告資料/大數據組需要分析的資料/107-114.03普悠瑪客運_台東市區客運"
years <- c("111", "112", "113")

# 1. 自動化讀檔與欄位補齊
import_and_align <- function(year, base_path) {
  data_path <- file.path(base_path, year)
  file_list <- list.files(data_path, full.names = TRUE)
  if(length(file_list) == 0) return(NULL)
  df_list <- map(file_list, read_excel)
  all_columns <- Reduce(union, lapply(df_list, names))
  df_list <- map(df_list, function(df) {
    missing_cols <- setdiff(all_columns, names(df))
    df[missing_cols] <- NA
    df[all_columns]
  })
  bind_rows(df_list)
}

# 2. 合併所有年度資料
combined_df <- map_dfr(years, import_and_align, base_path = base_path)

# 3. 時間處理：合併日期與時間欄位
combined_df <- combined_df %>%
  mutate(
    上車交易日期 = as.Date(上車交易日期, format = "%Y%m%d"),
    下車交易日期 = as.Date(下車交易日期, format = "%Y%m%d"),
    年月 = format(上車交易日期, "%Y%m"),
    上車時間 = as.POSIXct(paste0(上車交易日期, " ", sprintf("%06d", as.integer(上車交易時間))),
                           format = "%Y-%m-%d %H%M%S"),
    下車時間 = as.POSIXct(paste0(下車交易日期, " ", sprintf("%06d", as.integer(下車交易時間))),
                           format = "%Y-%m-%d %H%M%S")
  )

# 4. 轉成巢狀list（年月 > 路線名稱）
make_nested_list <- function(df, year_month_col = "年月", route_col = "路線編號") {
  year_months <- unique(df[[year_month_col]])
  result <- setNames(vector("list", length(year_months)), year_months)
  for (ym in year_months) {
    sub_df <- df %>% filter(.data[[year_month_col]] == ym)
    routes <- unique(sub_df[[route_col]])
    result[[ym]] <- setNames(
      lapply(routes, function(rn) sub_df %>% filter(.data[[route_col]] == rn)),
      routes
    )
  }
  result
}

nested_list <- make_nested_list(combined_df)

# 5. 檢查結構
names(nested_list)             # "202401" "202402" ...
names(nested_list[["202401"]]) # "301" "302" ...
str(nested_list, max.level = 2)

sort_and_complete_list <- function(nested_list, start_year = 2022, end_year = 2024) {
  # 生成完整年月
  all_months <- format(seq.Date(
    as.Date(paste0(start_year, "-01-01")),
    as.Date(paste0(end_year, "-12-01")),
    by = "month"
  ), "%Y%m")
  
  # 排序與補齊
  sorted_list <- lapply(all_months, function(ym) {
    if (ym %in% names(nested_list)) {
      # 排序路線名稱（支援數字與文字混合）
      routes <- names(nested_list[[ym]]) %>%
        gsub("[^0-9]", "", .) %>%  # 移除非數字字元（若存在）
        as.numeric() %>%
        sort() %>%
        as.character()
      nested_list[[ym]][routes]
    } else {
      list()
    }
  }) %>% setNames(all_months)
  
  # 移除 NA
  Filter(Negate(is.null), sorted_list)
}

# 使用範例
df <- sort_and_complete_list(nested_list)
```

## functions

```{r}
# simple summary for every variables
data_summary <- function(df){
  df_summary = list()
  pb <- txtProgressBar(min = 0, max = length(months), style = 3)
  for (month_index in 1:length(months)){
    df_summary[[months[month_index]]] <- lapply(df[[month_index]], function(data) {
      lapply(names(data), function(col) {
        data %>% count(.data[[col]])
      }) |> setNames(names(data))
    })
    names(df_summary[[months[month_index]]]) <- names(df[[month_index]])
    setTxtProgressBar(pb, month_index)
  }
  close(pb)
  return(df_summary)
}

# check the amounts of weekends and weekdays
monthly_weekday_and_weekend <- function(year, month){
  # build all dates 
  dates <- seq(ymd(sprintf("%d-%02d-01", year, month)),
               ceiling_date(ymd(sprintf("%d-%02d-01", year, month)), "month") - days(1),
               by = "day"
               )
  
  # is it weekend?
  is_weekend <- wday(dates) %in% c(1, 7)  # 1: Sunday, 7: Saturday
  
  # output
  result <- table(ifelse(is_weekend, "weekend", "weekday")) %>% data.frame()
  return(result)
}

# check the save path
check_path <- function(path) {
  if (!dir.exists(path)) {
    dir.create(path, recursive = TRUE, showWarnings = FALSE)
  }
}

# generate the specified month interval
generate_months <- function(year.from, year.to, month.from = 1, month.to = 12) {
  months = unlist(lapply(year.from:year.to, function(y) {sprintf("%04d%02d", y, month.from:month.to)}))
  return(months)
}

# convert HolderType to common ticket type
convert_holder_type <- function(types) {
  map <- c(
    "QR一般" = "一般票",
    "其他普通卡" = "一般票",
    "高市一般卡" = "一般票",
    "其他學生卡" = "學生票",
    "高市學生卡" = "學生票",
    "其他兒童卡" = "優待票",
    "其他陪伴卡" = "優待票",
    "其他愛心卡" = "優待票",
    "其他敬老卡" = "優待票",
    "高市陪伴全" = "優待票",
    "高市博愛卡" = "優待票",
    "高市敬老卡" = "優待票",
    "台東" = "TPASS",
    "台東通勤月票" = "TPASS",
    "臺東全區公路客運＋全臺鐵" = "TPASS"
  )
  result <- map[types]
  result[is.na(result)] <- "無法辨識"
  return(result)
}
```

## config

```{r}
# config
year.from = 2022  # 西元
year.to = 2024
month.from = 1
month.to = 12
buses = c("9801", "9803", "9805", "9806")

windowsFonts(kai = windowsFont("Microsoft JhengHei"))
```

## 計算搭乘時間

```{r}
# 整理日期，找出星期幾
# 新增 Weekday 欄位

# 上車分鐘與下車分鐘
# 上車分鐘指該天上車時間權全換為分鐘，如 21 小時 31 分 15 秒為 21 × 60 + 31 = 1291 分鐘
# 新增 BoardingTimeInMinutes 和 DeboardingTimeInMinutes 欄位

# 搭乘時間
# 是指下車分鐘減去上車分鐘
library(lubridate)

month.from = 1
month.to = 12
months = generate_months(year.from, year.to, month.from, month.to)

for (month_index in months) {
  for (bus_index in buses) {
    if (!bus_index %in% names(df[[month_index]])) {
      next  # 如果該公車路線不存在，則跳過
    }
    df[[month_index]][[bus_index]] <- df[[month_index]][[bus_index]] |>
      mutate(
        BoardingParsed = ymd_hms(上車時間),
        DeboardingParsed = ymd_hms(下車時間),
        
        # 星期幾
        Weekday = weekdays(coalesce(BoardingParsed, DeboardingParsed)),
        
        # 上車分鐘
        BoardingTimeInMinutes = hour(BoardingParsed) * 60 + minute(BoardingParsed) + second(BoardingParsed) / 60,
        
        # 下車分鐘
        DeboardingTimeInMinutes = hour(DeboardingParsed) * 60 + minute(DeboardingParsed) + second(DeboardingParsed) / 60,
        
        # 搭乘時間
        TravelTime = DeboardingTimeInMinutes - BoardingTimeInMinutes
      ) |>
      select(-BoardingParsed, -DeboardingParsed)  # 清除中間欄位
  }
}
```

## df_summary

```{r}
# simple summary for every variables
month.from = 1
month.to = 12
months = generate_months(year.from, year.to, month.from, month.to)
df_summary = data_summary(df)

#df_summary  
```

## 生成月成長資料

```{r}
# 生成月成長資料
df_grow.month <- list()

for (bus_index in buses) {
  df_grow.month.temp <- data.frame(
    年份 = character(),
    月份 = numeric(),
    成長人數 = numeric(),
    成長百分比 = numeric(),
    stringsAsFactors = FALSE
  )
  
  if (year.from > (year.to - 1)){
    break
  }
  
  for (year in year.from:(year.to - 1)) {
    for (month_index in month.from:month.to) {
      ym_current <- sprintf("%04d%02d", year, month_index)
      ym_next <- sprintf("%04d%02d", year + 1, month_index)
      
      if (!is.null(df[[ym_current]][[bus_index]]) && !is.null(df[[ym_next]][[bus_index]])) {
        a <- nrow(df[[ym_current]][[bus_index]])
        b <- nrow(df[[ym_next]][[bus_index]])
        growth_count <- b - a
        growth_rate <- (b - a) / a

        df_grow.month.temp <- rbind(df_grow.month.temp, data.frame(
          年份 = year + 1,
          月份 = month_index,
          成長人數 = growth_count,
          成長百分比 = round(growth_rate, 2),
          stringsAsFactors = FALSE
        ))
      } else {
        # 如果沒有資料，則填NA
        df_grow.month.temp <- rbind(df_grow.month.temp, data.frame(
          年份 = year + 1,
          月份 = month_index,
          成長人數 = NA,
          成長百分比 = NA,
          stringsAsFactors = FALSE
        ))
      }
    }
  }
  
  # 儲存到對應 bus 的 list 中
  df_grow.month[[bus_index]] <- df_grow.month.temp
}

df_grow.month[[1]]
```

## 生成月平假日成長資料

```{r}
# 生成月平假日成長資料
df_grow.week <- list()

for (bus_index in buses) {
  week_grow_df <- data.frame(
    年份 = character(),
    月份 = numeric(),
    平日或假日 = character(),
    平均成長人數 = numeric(),
    成長百分比 = numeric(),
    stringsAsFactors = FALSE
  )
        
# 平假日名稱
weekday_names <- c("星期一", "星期二", "星期三", "星期四", "星期五")
weekend_names <- c("星期六", "星期日")
  
  for (year in year.from:(year.to - 1)) {
    for (month in month.from:month.to) {
      ym_current <- sprintf("%04d%02d", year, month)
      ym_next <- sprintf("%04d%02d", year + 1, month)
      
      # 檢查該月該車資料是否存在
      if (!is.null(df_summary[[ym_current]][[bus_index]]) && !is.null(df_summary[[ym_next]][[bus_index]])) {
        
        # 取得每月的平假日總人次
        wd_current <- df_summary[[ym_current]][[bus_index]][['Weekday']]
        wd_next <- df_summary[[ym_next]][[bus_index]][['Weekday']]
        
        # 平日與假日人次總和
        total_weekday_current <- sum(wd_current$n[wd_current$Weekday %in% weekday_names])
        total_weekday_next <- sum(wd_next$n[wd_next$Weekday %in% weekday_names])
        total_weekend_current <- sum(wd_current$n[wd_current$Weekday %in% weekend_names])
        total_weekend_next <- sum(wd_next$n[wd_next$Weekday %in% weekend_names])
        
        # 平假日天數
        freq_current <- monthly_weekday_and_weekend(year, month)[['Freq']]
        freq_next <- monthly_weekday_and_weekend(year + 1, month)[['Freq']]
        
        if (length(freq_current) == 2 && length(freq_next) == 2 && freq_next[1] > 0 && freq_next[2] > 0) {
          
          # 平均值
          avg_weekday_current <- total_weekday_current / freq_current[1]
          avg_weekday_next <- total_weekday_next / freq_next[1]
          avg_weekend_current <- total_weekend_current / freq_current[2]
          avg_weekend_next <- total_weekend_next / freq_next[2]
          
          # 成長量與百分比
          growth_weekday <- avg_weekday_next - avg_weekday_current
          growth_rate_weekday <- growth_weekday / avg_weekday_current
          
          growth_weekend <- avg_weekend_next - avg_weekend_current
          growth_rate_weekend <- growth_weekend / avg_weekend_current
          
          # 寫入資料框
          week_grow_df <- rbind(week_grow_df, data.frame(
            年份 = year + 1,
            月份 = month,
            平日或假日 = "平日",
            平均成長人數 = round(growth_weekday, 2),
            成長百分比 = round(growth_rate_weekday, 2),
            stringsAsFactors = FALSE
          ))
          
          week_grow_df <- rbind(week_grow_df, data.frame(
            年份 = year + 1,
            月份 = month,
            平日或假日 = "假日",
            平均成長人數 = round(growth_weekend, 2),
            成長百分比 = round(growth_rate_weekend, 2),
            stringsAsFactors = FALSE
          ))
        }
      } else {
        # 如果沒有資料，則填NA
        week_grow_df <- rbind(week_grow_df, data.frame(
          年份 = year + 1,
          月份 = month,
          平日或假日 = "平日",
          平均成長人數 = NA,
          成長百分比 = NA,
          stringsAsFactors = FALSE
        ))
        
        week_grow_df <- rbind(week_grow_df, data.frame(
          年份 = year + 1,
          月份 = month,
          平日或假日 = "假日",
          平均成長人數 = NA,
          成長百分比 = NA,
          stringsAsFactors = FALSE
        ))
      }
    }
  }
  
  # 儲存至該 bus_index 的結果
  df_grow.week[[bus_index]] <- week_grow_df
}

df_grow.week[[1]]
```

## 定義站點

"9801": 市區循環線
"9803": 火車站-小野柳 # 去返程經過站點不一樣
"9805": 旅服中心-火車站
"9806": 航空站-火車站

ref:
https://www.taiwanbus.tw/eBUSPage/Query/CustomerQuery.aspx?lan=C

```{r}
# 定義站點

bus_stops = list()
bus_stops[['9801']] = c("台東火車站",
                        "拖吊場",
                        "棒球場",
                        "寶桑國中",
                        "浙江路口",
                        "台東森林公園",
                        "天天來",
                        "吳外科",
                        "中華會館",
                        "海濱公園",
                        "大同路郵局",
                        "中華正氣路口",
                        "台東轉運站",
                        "體育場(鐵花村)",
                        "馬偕醫院",
                        "後期聖徒教會",
                        "台東高商",
                        "聖母醫院",
                        "縣民服務中心",
                        "美術館(地檢署)",
                        "基督教醫院",
                        "開封長安街口",
                        "新生郵局",
                        "台東糖廠",
                        "東方大鎮",
                        "娜路彎大酒店",
                        "卑南入口",
                        "棒球場",
                        "拖吊場",
                        "台東火車站")

bus_stops[['9803']] = c("台東火車站",
                        "拖吊場",
                        "棒球場",
                        "寶桑國中",
                        "浙江路口",
                        "台東森林公園",
                        "富岡港口")
# 返程
# "富岡港口",
# "小野柳",
# "美娥餐廳",
# "台東森林公園",
# "浙江路口",
# "寶桑國中",
# "棒球場",
# "拖吊場",
# "台東火車站"

bus_stops[['9805']] = c("台東火車站",
                        "拖吊場",
                        "棒球場",
                        "寶桑國中",
                        "浙江路口",
                        "台東森林公園",
                        "天天來",
                        "吳外科",
                        "中央市場",
                        "台東轉運站")

bus_stops[['9806']] = c("台東航空站",
                        "陽明山莊",
                        "康樂國小",
                        "專科學校",
                        "縣議會",
                        "東方大鎮",
                        "台東糖廠",
                        "公東高工",
                        "馬蘭榮家",
                        "卑南入口",
                        "棒球場",
                        "拖吊場",
                        "台東火車站")
```

## volume_plot: 給定路線下的月運量

```{r}
# 運量
volume_plot <- function(bus, year) {
  transport_volume = NULL
  months = generate_months(year, year, month.from, month.to)
  for (month_index in months){
    transport_volume = c(transport_volume,
                         ifelse (is.null(nrow(df[[month_index]][[bus]])),
                                 0,
                                 nrow(df[[month_index]][[bus]]))
                         )
  }
  
  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = transport_volume,
       type = "o",
       lwd = 2,
       pch = 16,
       col = "gray",
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(transport_volume) * 0.9, max(transport_volume) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線搭乘次數折線圖'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  text(x = month.from:month.to,
       y = transport_volume + max(transport_volume) * 0.02,
       labels = transport_volume,
       pos = 3,            # 文字顯示在點上方
       cex = 1.5,          # 文字大小
       col = "black"
  )
  
  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = paste0(bus, '路線'), 
         col = "gray", 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}

# 全年
month.from = 1
month.to = 12
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    volume_plot(bus, year)
    
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線搭乘次數折線圖')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    volume_plot(bus, year)
    dev.off()
  }
}

# 上半
month.from = 1
month.to = 6
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    volume_plot(bus, year)
    
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線搭乘次數折線圖')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    volume_plot(bus, year)
    dev.off()
  }
}

# 下半
month.from = 7
month.to = 12
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    volume_plot(bus, year)
    
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線搭乘次數折線圖')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    volume_plot(bus, year)
    dev.off()
  }
}
```

## 平假日搭乘次數

```{r}
# 平假日搭乘次數
weekend_and_weekday_volume_plot <- function(bus, year) {
  months = generate_months(year, year, month.from, month.to)
  weekend.days = NULL
  weekday.days = NULL
  month.days = NULL
  weekend.volume = NULL
  weekday.volume = NULL
  month.volume = NULL
  color <- gray.colors(3+1)
  
  for (month_index in month.from:month.to){
    week.days = monthly_weekday_and_weekend(year = year, month = month_index)[['Freq']]
    weekday.days = c(weekday.days, week.days[1])
    weekend.days = c(weekend.days, week.days[2])
    month.days = c(month.days, sum(week.days))
    
    week.volume = df_summary[[sprintf("%04d%02d", year, month_index)]][[bus]][['Weekday']]
    weekday.volume = c(weekday.volume, sum(week.volume$n[week.volume$Weekday %in% c("星期一", "星期二", "星期三", "星期四", "星期五")]))
    weekend.volume = c(weekend.volume, sum(week.volume$n[week.volume$Weekday %in% c("星期六", "星期日")]))
    month.volume = c(month.volume, sum(week.volume$n))
  }
  
  weekday.volume.per_day = weekday.volume / weekday.days
  weekend.volume.per_day = weekend.volume / weekend.days
  month.volume.per_day = month.volume / month.days
  
  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = month.volume.per_day,
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "日均人次",
       ylim = c(min(weekday.volume.per_day, weekend.volume.per_day, month.volume.per_day) * 0.9,
                max(weekday.volume.per_day, weekend.volume.per_day, month.volume.per_day) * 1.1
                ),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線日均搭乘次數折線圖'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  lines(x = month.from:month.to,
        y = weekday.volume.per_day,
        type = "o",
        lwd = 2,
        pch = 16,
        col = color[2]
        )
  
  lines(x = month.from:month.to,
        y = weekend.volume.per_day,
        type = "o",
        lwd = 2,
        pch = 16,
        col = color[3]
        )
  
  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = c("月日均", "平日日均", "假日日均"), 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.16, 0),
         xpd = TRUE,
         cex = 1.5
         )
}

# 全年
month.from = 1
month.to = 12
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    weekend_and_weekday_volume_plot(bus, year)
  
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線日均搭乘次數折線圖')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    weekend_and_weekday_volume_plot(bus, year)
    dev.off()
  }
}

# 上半
month.from = 1
month.to = 6
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    weekend_and_weekday_volume_plot(bus, year)
  
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線日均搭乘次數折線圖')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    weekend_and_weekday_volume_plot(bus, year)
    dev.off()
  }
}

# 下半
month.from = 7
month.to = 12
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    weekend_and_weekday_volume_plot(bus, year)
  
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線日均搭乘次數折線圖')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    weekend_and_weekday_volume_plot(bus, year)
    dev.off()
  }
}
```

## 單一年總運量: 比較不同路線的月運量

```{r}
total_volume_plot <- function(buses, year) {
  months = generate_months(year, year, month.from, month.to)
  color <- gray.colors(length(buses)+2)
  
  transport_volume = NULL
  for (bus in buses){
    transport_each_volume = NULL
    for (month_index in months){
      transport_each_volume = c(transport_each_volume,
                                ifelse (is.null(nrow(df[[month_index]][[bus]])), 
                                        0,
                                        nrow(df[[month_index]][[bus]]))
                                )
    }
    transport_volume = c(transport_volume, list(transport_each_volume))
  }
  transport_volume = append(list(Reduce("+", transport_volume)), transport_volume)  # total

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = transport_volume[[1]],
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(sapply(transport_volume, min)) * 0.9 , max(sapply(transport_volume, max)) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月普悠瑪客運總運量'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  for(bus_index in 2:(length(buses)+1)){
    lines(x = month.from:month.to,
      y = transport_volume[[bus_index]],
      type = "o",
      lwd = 2,
      pch = 16,
      cex = 1.5,
      col = color[bus_index]
      )
  }

  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = c('總人次', paste0(buses, '路線')), 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}

# 全年
month.from = 1
month.to = 12
for (year in year.from:year.to){
  # 繪圖 (在 R中呈現)
  total_volume_plot(buses, year)
  
  # 儲存圖片
  path = paste0("images/", year - 1911, "/total/line_chart")
  check_path(path)
  main = paste0(year - 1911, '年', month.from, '月至', month.to, '月普悠瑪客運總運量')
  png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  total_volume_plot(buses, year)
  dev.off()
}

# 上半
month.from = 1
month.to = 6
for (year in year.from:year.to){
  # 繪圖 (在 R中呈現)
  total_volume_plot(buses, year)
  
  # 儲存圖片
  path = paste0("images/", year - 1911, "/total/line_chart")
  check_path(path)
  main = paste0(year - 1911, '年', month.from, '月至', month.to, '月普悠瑪客運總運量')
  png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  total_volume_plot(buses, year)
  dev.off()
}

# 下半
month.from = 7
month.to = 12
for (year in year.from:year.to){
  # 繪圖 (在 R中呈現)
  total_volume_plot(buses, year)
  
  # 儲存圖片
  path = paste0("images/", year - 1911, "/total/line_chart")
  check_path(path)
  main = paste0(year - 1911, '年', month.from, '月至', month.to, '月普悠瑪客運總運量')
  png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  total_volume_plot(buses, year)
  dev.off()
}
```

## 多年總運量(月): 比較不同年的月總運量

```{r}
month_total_volume_plot <- function(buses, year.from, year.to) {
  years = year.from:year.to
  color <- gray.colors(length(years)+1)
  
  transport_volume_year = list()
  for (year in years) {
    months = generate_months(year, year, month.from, month.to)
    transport_volume = rep(0, length(buses))
    for (bus in buses){
      transport_each_volume = NULL
      for (month_index in months){
        transport_each_volume = c(transport_each_volume,
                                  ifelse (is.null(nrow(df[[month_index]][[bus]])),
                                          0,
                                          nrow(df[[month_index]][[bus]]))
                                  )
      }
      transport_volume = transport_volume + transport_each_volume
    }
    transport_volume_year[[as.character(year)]] = transport_volume  # total
  }

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = transport_volume_year[[1]],
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(sapply(transport_volume_year, min)) * 0.9 , max(sapply(transport_volume_year, max)) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )

  title(main = paste0(year.from - 1911, '年', '至', year.to - 1911, '年普悠瑪客運月總運量'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  for(year_index in 2:(length(years))){
    lines(x = month.from:month.to,
          y = transport_volume_year[[year_index]],
          type = "o",
          lwd = 2,
          pch = 16,
          cex = 1.5,
          col = color[year_index]
          )
  }   

  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = paste0(years - 1911, '年'), 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}


# 全年
month.from = 1
month.to = 12

# 繪圖 (在 R中呈現)
month_total_volume_plot(buses, year.from, year.to)

# 儲存圖片
path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/total/line_chart")
check_path(path)
main = paste0(year.from - 1911, '年', '至', year.to - 1911, '年普悠瑪客運月總運量')
png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
month_total_volume_plot(buses, year.from, year.to)
dev.off()


# 上半
month.from = 1
month.to = 6

# 繪圖 (在 R中呈現)
month_total_volume_plot(buses, year.from, year.to)

# 儲存圖片
path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/total/line_chart")
check_path(path)
main = paste0(year.from - 1911, '年', '至', year.to - 1911, '年普悠瑪客運月總運量')
png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
month_total_volume_plot(buses, year.from, year.to)
dev.off()


# 下半
month.from = 7
month.to = 12

# 繪圖 (在 R中呈現)
month_total_volume_plot(buses, year.from, year.to)

# 儲存圖片
path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/total/line_chart")
check_path(path)
main = paste0(year.from - 1911, '年', '至', year.to - 1911, '年普悠瑪客運月總運量')
png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
month_total_volume_plot(buses, year.from, year.to)
dev.off()
```

## 多年總運量(年): 比較不同年的年運量

```{r}
# 太魯閣客運多年總運量(年)
year_total_volume_plot <- function(buses, year.from, year.to) {
  years = year.from:year.to
  color <- gray.colors(2)
  
  transport_volume_year <- sapply(years, function(year) {
    months <- generate_months(year, year, month.from, month.to)
    sum(sapply(buses, function(bus) {
      sum(sapply(months, function(month_index) {
        ifelse(is.null(nrow(df[[month_index]][[bus]])), 
               0, 
               nrow(df[[month_index]][[bus]])
        )
      }))
    }))
  }) %>% c()
  
  print(transport_volume_year)

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = years,
       y = transport_volume_year,
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "年",
       ylab = "搭乘次數",
       ylim = c(min(sapply(transport_volume_year, min)) * 0.9 , max(sapply(transport_volume_year, max)) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year.from - 1911, '年', '至', year.to - 1911, '年普悠瑪客運年總運量'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = years, labels = c(years - 1911), cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)

  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = "總運量", 
         col = color[1], 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}


# 繪圖 (在 R中呈現)
year_total_volume_plot(buses, year.from, year.to)

# 儲存圖片
path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/total/line_chart")
check_path(path)
main = paste0(year.from - 1911, '年', '至', year.to - 1911, '年普悠瑪客運年總運量')
png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
year_total_volume_plot(buses, year.from, year.to)
dev.off()
```

## 多年總運量: 給定路線下比較不同年的月運量

```{r}
# 太魯閣客運多年總運量
volume_by_bus_plot <- function(bus, year.from, year.to) {
  years = year.from:year.to
  color <- gray.colors(length(years)+1)
  
  transport_volume_year = list()
  for (year in years) {
    months = generate_months(year, year, month.from, month.to)
    transport_each_volume = NULL
    for (month_index in months){
      transport_each_volume = c(transport_each_volume,
                                ifelse (is.null(nrow(df[[month_index]][[bus]])),
                                        0,
                                        nrow(df[[month_index]][[bus]])
                                        )
                                )
    }
    transport_volume_year[[as.character(year)]] = transport_each_volume  # total
  }
  

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = transport_volume_year[[1]],
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(sapply(transport_volume_year, min)) * 0.9 , max(sapply(transport_volume_year, max)) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year.from - 1911, '年至', year.to - 1911, '年', month.from, '月至', month.to, '月', bus, '路線月運量'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  for(year_index in 2:(length(years))){
    lines(x = month.from:month.to,
          y = transport_volume_year[[year_index]],
          type = "o",
          lwd = 2,
          pch = 16,
          cex = 1.5,
          col = color[year_index]
          )
  }   

  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = paste0(years - 1911, '年'), 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}


# 全年
month.from = 1
month.to = 12

for(bus in buses){
  # 繪圖 (在 R中呈現)
  volume_by_bus_plot(bus, year.from, year.to)
  
  # 儲存圖片
  path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/", bus, "/line_chart")
  check_path(path)
  main = paste0(year.from - 1911, '年至', year.to - 1911, '年', month.from, '月至', month.to, '月', bus, '路線月運量')
  png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  volume_by_bus_plot(bus, year.from, year.to)
  dev.off()
}


# 上半
month.from = 1
month.to = 6

for(bus in buses){
  # 繪圖 (在 R中呈現)
  volume_by_bus_plot(bus, year.from, year.to)
  
  # 儲存圖片
  path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/", bus, "/line_chart")
  check_path(path)
  main = paste0(year.from - 1911, '年至', year.to - 1911, '年', month.from, '月至', month.to, '月', bus, '路線月運量')
  png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  volume_by_bus_plot(bus, year.from, year.to)
  dev.off()
}


# 下半
month.from = 7
month.to = 12

for(bus in buses){
  # 繪圖 (在 R中呈現)
  volume_by_bus_plot(bus, year.from, year.to)
  
  # 儲存圖片
  path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/", bus, "/line_chart")
  check_path(path)
  main = paste0(year.from - 1911, '年至', year.to - 1911, '年', month.from, '月至', month.to, '月', bus, '路線月運量')
  png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  volume_by_bus_plot(bus, year.from, year.to)
  dev.off()
}
```

  ## 月增長量

```{r}
monthly_gorw_up_plot <- function(bus, year) {
  color <- "gray"
  
  df_grow_year = df_grow.month[[bus]] %>% filter(年份 == year & 月份 %in% month.from:month.to)
  df_grow_year <- df_grow_year$成長人數

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = df_grow_year,
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "成長人數",
       ylim = c(min(df_grow_year, na.rm = T) * ifelse(min(df_grow_year, na.rm = T) > 0, 0.9, 1.1) , max(df_grow_year, na.rm = T) * 1.2),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year - 1 - 1911, '、', year - 1911, '年',
                      month.from, '月至', month.to, '月',
                      bus, '路線運量消長情形同期比較'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)

  grid()  # 網格線
  
  text(x = month.from:month.to,
       y = df_grow_year + max(df_grow_year) * 0.01,
       labels = df_grow_year,
       pos = 3,            # 文字顯示在點上方
       cex = 1.5,          # 文字大小
       col = "black"
  )
  
  # 圖例
  legend("topright", 
         legend = '增長量', 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}


# 全年
month.from = 1
month.to = 12
for(bus in buses){
  for (year in (year.from + 1):year.to){
    # 繪圖 (在 R中呈現)
    monthly_gorw_up_plot(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0(year - 1 - 1911, '、', year - 1911, '年',
                  month.from, '月至', month.to, '月',
                  bus, '路線運量消長情形同期比較')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    monthly_gorw_up_plot(bus, year)
    dev.off()
  }
}


# 上半
month.from = 1
month.to = 6
for(bus in buses){
  for (year in (year.from + 1):year.to){
    # 繪圖 (在 R中呈現)
    monthly_gorw_up_plot(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0(year - 1 - 1911, '、', year - 1911, '年',
                  month.from, '月至', month.to, '月',
                  bus, '路線運量消長情形同期比較')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    monthly_gorw_up_plot(bus, year)
    dev.off()
  }
}


# 下半
month.from = 7
month.to = 12
for(bus in buses){
  for (year in (year.from + 1):year.to){
    # 繪圖 (在 R中呈現)
    monthly_gorw_up_plot(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0(year - 1 - 1911, '、', year - 1911, '年',
                  month.from, '月至', month.to, '月',
                  bus, '路線運量消長情形同期比較')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    monthly_gorw_up_plot(bus, year)
    dev.off()
  }
}
```

## 月平假日增長量

```{r}
# 月平假日增長量
weekday_and_weekend_gorw_up_plot <- function(bus, year) {
  color <- gray.colors(3)
  
  df_grow_year = df_grow.week[[bus]] %>%  filter(年份 == year & 月份 %in% month.from:month.to)
  df_grow_weekday <- (df_grow_year %>% filter(平日或假日 == '平日'))$平均成長人數
  df_grow_weekend <- (df_grow_year %>% filter(平日或假日 == '假日'))$平均成長人數

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = df_grow_weekday,
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "成長人數",
       ylim = c(min(df_grow_year$平均成長人數, na.rm = T) * ifelse(min(df_grow_year$平均成長人數, na.rm = T) > 0, 0.9, 1.1) , max(df_grow_year$平均成長人數, na.rm = T) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year - 1 - 1911, '、', year - 1911, '年',
                      month.from, '月至', month.to, '月',
                      bus, '路線平假日日均次數消長情形'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  lines(x = month.from:month.to,
        y = df_grow_weekend,
        type = "o",
        lwd = 2,
        pch = 16,
        cex = 1.5,
        col = color[2]
        )

  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = c('平日', '假日'), 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}


# 全年
month.from = 1
month.to = 12
for(bus in buses){
  for (year in (year.from + 1):year.to){
    # 繪圖 (在 R中呈現)
    weekday_and_weekend_gorw_up_plot(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0(year - 1 - 1911, '、', year - 1911, '年',
                      month.from, '月至', month.to, '月',
                      bus, '路線平假日日均次數消長情形')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    weekday_and_weekend_gorw_up_plot(bus, year)
    dev.off()
  }
}


# 上半
month.from = 1
month.to = 6
for(bus in buses){
  for (year in (year.from + 1):year.to){
    # 繪圖 (在 R中呈現)
    weekday_and_weekend_gorw_up_plot(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0(year - 1 - 1911, '、', year - 1911, '年',
                      month.from, '月至', month.to, '月',
                      bus, '路線平假日日均次數消長情形')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    weekday_and_weekend_gorw_up_plot(bus, year)
    dev.off()
  }
}


# 下半
month.from = 7
month.to = 12
for(bus in buses){
  for (year in (year.from + 1):year.to){
    # 繪圖 (在 R中呈現)
    weekday_and_weekend_gorw_up_plot(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0(year - 1 - 1911, '、', year - 1911, '年',
                      month.from, '月至', month.to, '月',
                      bus, '路線平假日日均次數消長情形')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    weekday_and_weekend_gorw_up_plot(bus, year)
    dev.off()
  }
}
```

## 路線搭車票種長條圖

```{r}
tick_type_histgram <- function(bus, year) {
  months = generate_months(year, year, month.from, month.to)
  
  df_ticket = data.frame()
  for(month_index in months){
    df_ticket = rbind(df_ticket,
                      df[[month_index]][[bus]])
  }

  df_ticket <- convert_holder_type(df_ticket$交易票種) %>% table()
  color <- gray.colors(length(df_ticket))
  
  par(family = "kai", mar = c(5, 6, 4, 3))  # 字體與圖寬
  
  bp <- barplot(height = df_ticket,
                col = color,
                xlab = "票種",
                ylab = "數量",
                las = 1,
                cex.main = 2,
                cex.lab = 2,
                cex.axis = 1.5,
                cex = 1.5,
                yaxt = "n",
                main = "",
                ylim = c(0, max(df_ticket) * 1.1)
                )

  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線搭車票種'), cex.main = 2, adj = 0)
  
  # x 軸
  #axis(side = 1, at = 1:length(df_ticket), labels = c(names(df_ticket)), cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  # 百分比
  labels <- paste0(round(df_ticket * 100 / sum(df_ticket)), "%")
  
  text(x = bp, 
       y = df_ticket, 
       labels = labels, 
       pos = 3,
       cex = 1.5)
  
}


# 全年
month.from = 1
month.to = 12
for(bus in buses){
  for (year in year.from:year.to){
    # 繪圖 (在 R中呈現)
    tick_type_histgram(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/barplot")
    check_path(path)
    main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線搭車票種')
    png(filename = paste0(path, "/", main, ".png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
    tick_type_histgram(bus, year)
    dev.off()
  }
}


# 上半
month.from = 1
month.to = 6
for(bus in buses){
  for (year in year.from:year.to){
    # 繪圖 (在 R中呈現)
    tick_type_histgram(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/barplot")
    check_path(path)
    main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線搭車票種')
    png(filename = paste0(path, "/", main, ".png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
    tick_type_histgram(bus, year)
    dev.off()
  }
}


# 下半
month.from = 7
month.to = 12
for(bus in buses){
  for (year in year.from:year.to){
    # 繪圖 (在 R中呈現)
    tick_type_histgram(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/barplot")
    check_path(path)
    main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線搭車票種')
    png(filename = paste0(path, "/", main, ".png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
    tick_type_histgram(bus, year)
    dev.off()
  }
}
```

## 路線搭車票種長條圖: 去回程

```{r}
# 路線搭車票種長條圖 (去程，direction = 0; 回程，direction = 1)
tick_type_direction_histgram <- function(bus, year, direction) {
  months = generate_months(year, year, month.from, month.to)
  
  df_ticket = data.frame()
  for(month_index in months){
    idx = ifelse (df[[month_index]][[bus]][["去返程"]] == "里程去程",
                        0,
                        1
    )  # 去程為 0，回程為 1
    df_ticket = rbind(df_ticket,
                      df[[month_index]][[bus]][
                        idx == direction, ]
                      )
  }
  
  df_ticket <- convert_holder_type(df_ticket$交易票種) %>% table()
  color <- gray.colors(length(df_ticket))
  
  par(family = "kai", mar = c(5, 6, 4, 3))  # 字體與圖寬
  
  bp <- barplot(height = df_ticket,
                col = color,
                xlab = "票種",
                ylab = "數量",
                las = 1,
                cex.main = 2,
                cex.lab = 2,
                cex.axis = 1.5,
                cex = 1.5,
                yaxt = "n",
                main = "",
                ylim = c(0, max(df_ticket) * 1.1)
                )

  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線', ifelse(direction == 0, '去程', '回程'), '搭車票種'), cex.main = 2, adj = 0)
  
  # x 軸
  #axis(side = 1, at = 1:length(df_ticket), labels = c(names(df_ticket)), cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  # 百分比
  labels <- paste0(round(df_ticket * 100 / sum(df_ticket)), "%")
  
  text(x = bp, 
       y = df_ticket, 
       labels = labels, 
       pos = 3,
       cex = 1.5)
  
}


# 全年
month.from = 1
month.to = 12
for (direction in 0:1){
  for(bus in buses){
    for (year in year.from:year.to){
      # 繪圖 (在 R中呈現)
      tick_type_direction_histgram(bus, year, direction)
      
      # 儲存圖片
      path = paste0("images/", year - 1911, "/", bus, "/barplot")
      check_path(path)
      main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線', ifelse(direction == 0, '去程', '回程'), '搭車票種')
      png(filename = paste0(path, "/", main, ".png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
      tick_type_direction_histgram(bus, year, direction)
      dev.off()
    }
  }
}



# 上半
month.from = 1
month.to = 6
for (direction in 0:1){
  for(bus in buses){
    for (year in year.from:year.to){
      # 繪圖 (在 R中呈現)
      tick_type_direction_histgram(bus, year, direction)
      
      # 儲存圖片
      path = paste0("images/", year - 1911, "/", bus, "/barplot")
      check_path(path)
      main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線', ifelse(direction == 0, '去程', '回程'), '搭車票種')
      png(filename = paste0(path, "/", main, ".png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
      tick_type_direction_histgram(bus, year, direction)
      dev.off()
    }
  }
}


# 下半
month.from = 7
month.to = 12
for (direction in 0:1){
  for(bus in buses){
    for (year in year.from:year.to){
      # 繪圖 (在 R中呈現)
      tick_type_direction_histgram(bus, year, direction)
      
      # 儲存圖片
      path = paste0("images/", year - 1911, "/", bus, "/barplot")
      check_path(path)
      main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線', ifelse(direction == 0, '去程', '回程'), '搭車票種')
      png(filename = paste0(path, "/", main, ".png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
      tick_type_direction_histgram(bus, year, direction)
      dev.off()
    }
  }
}
```

## 平假日路線各上下車站點票種直方疊圖: 去回程

```{r}
# 平假日路線各上下車站點票種直方疊圖 (去程，direction = 0; 回程，direction = 1)
tick_type_week_day_direction_histgram <- function(bus, year, week_day, direction, boarding) {
  months = generate_months(year, year, month.from, month.to)
  if (week_day == '平日'){
    weekday = c("星期一", "星期二", "星期三", "星期四", "星期五")
  } else {
    weekday = c("星期六", "星期日")
  }
  df_ticket <- data.frame()
  for (month_index in months) {
    df_month <- df[[month_index]][[bus]]
    idx = ifelse (df_month$"去返程" == "里程去程",
                        0,
                        1
    )  # 去程為 0，回程為 1
    df_month <- df_month[idx == direction, ]
    df_ticket <- rbind(df_ticket, df_month)
  }

  df_ticket <- df_ticket[df_ticket$Weekday %in% weekday, ]  # 抓取平假日 
  if (boarding){
    df_ticket <- df_ticket[!is.na(df_ticket$上車招呼站名稱), ]  #移除逃票
    table_limit <- max(table(df_ticket$上車招呼站名稱))
  } else {
    df_ticket <- df_ticket[!is.na(df_ticket$下車招呼站名稱), ]  #移除逃票
    table_limit <- max(table(df_ticket$下車招呼站名稱))
  }
  
  df_ticket$交易票種 <- convert_holder_type(df_ticket$交易票種)

  if (boarding){
    # 建立完整的票種統計表
    ticket_count_full <- table(df_ticket$交易票種, df_ticket$上車招呼站名稱)
    
    # 將表格轉換為資料框進行處理
    ticket_df <- as.data.frame.table(ticket_count_full)
    names(ticket_df) <- c("票種", "站點", "次數")
    
    # 計算各站點總運量並選取前十名（包含並列）
    station_summary <- ticket_df %>%
      group_by(站點) %>%
      summarise(總運量 = sum(次數)) %>%
      top_n(10, 總運量) %>% 
      arrange(總運量)
    
    # 篩選原始資料
    top_stations <- station_summary$站點
    ticket_count <- ticket_count_full[, as.character(top_stations)]
        
  } else {
    # 建立完整的票種統計表
    ticket_count_full <- table(df_ticket$交易票種, df_ticket$下車招呼站名稱)
    
    # 將表格轉換為資料框進行處理
    ticket_df <- as.data.frame.table(ticket_count_full)
    names(ticket_df) <- c("票種", "站點", "次數")
    
    # 計算各站點總運量並選取前十名（包含並列）
    station_summary <- ticket_df %>%
      group_by(站點) %>%
      summarise(總運量 = sum(次數)) %>%
      top_n(10, 總運量) %>% 
      arrange(總運量)
    
    # 篩選原始資料
    top_stations <- station_summary$站點
    ticket_count <- ticket_count_full[, as.character(top_stations)]
  }
  color <- gray.colors(nrow(ticket_count))
  #color <- rainbow(nrow(ticket_count))
  
  par(family = "kai", mar = c(5, 13, 2, 6))  # 字體與圖寬 c(bottom, left, top, right)
  
  barplot(height = ticket_count,
          col = color,
          xlab = "票種疊圖",
          #ylab = "站別",
          las = 1,
          horiz = TRUE,
          cex.main = 2,
          cex.lab = 2,
          cex.axis = 1.5,
          cex = 1.5,
          #yaxt = "n",
          main = "",
          xlim = c(0, table_limit * 1.1)
          )

  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線', ifelse(direction == 0, '去程', '回程'), ifelse(week_day == '平日', '平日', '假日'), '各', ifelse(boarding, '上', '下'), '車站點票種直方疊圖'), cex.main = 2, adj = 0)
  
  # x 軸
  #axis(side = 1, at = 1:length(ticket_count), labels = c(names(ticket_count)), cex.axis = 1.5)
  
  # y 軸
  #axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
    # 圖例
  legend("bottomright", 
         legend = rownames(ticket_count), 
         fill =  color, 
         title = "票種",
         cex = 1.5
         )

}


# 全年
month.from = 1
month.to = 12
for(boarding in c(TRUE, FALSE)){
  for (week_day in c('平日', '假日')){
    for (direction in 0:1){
      for(bus in buses){
        for (year in year.from:year.to){
          # 繪圖 (在 R中呈現)
          tick_type_week_day_direction_histgram(bus, year, week_day, direction, boarding)
          
          # 儲存圖片
          path = paste0("images/", year - 1911, "/", bus, "/barplot")
          check_path(path)
          main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線', ifelse(direction == 0, '去程', '回程'), ifelse(week_day == '平日', '平日', '假日'), '各', ifelse(boarding, '上', '下'), '車站點票種直方疊圖')
          png(filename = paste0(path, "/", main, ".png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
          tick_type_week_day_direction_histgram(bus, year, week_day, direction, boarding)
          dev.off()
        }
      }
    }
  }
}


# 上半
month.from = 1
month.to = 6
for(boarding in c(TRUE, FALSE)){
  for (week_day in c('平日', '假日')){
    for (direction in 0:1){
      for(bus in buses){
        for (year in year.from:year.to){
          # 繪圖 (在 R中呈現)
          tick_type_week_day_direction_histgram(bus, year, week_day, direction, boarding)
          
          # 儲存圖片
          path = paste0("images/", year - 1911, "/", bus, "/barplot")
          check_path(path)
          main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線', ifelse(direction == 0, '去程', '回程'), ifelse(week_day == '平日', '平日', '假日'), '各', ifelse(boarding, '上', '下'), '車站點票種直方疊圖')
          png(filename = paste0(path, "/", main, ".png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
          tick_type_week_day_direction_histgram(bus, year, week_day, direction, boarding)
          dev.off()
        }
      }
    }
  }
}


# 下半
month.from = 7
month.to = 12
for(boarding in c(TRUE, FALSE)){
  for (week_day in c('平日', '假日')){
    for (direction in 0:1){
      for(bus in buses){
        for (year in year.from:year.to){
          # 繪圖 (在 R中呈現)
          tick_type_week_day_direction_histgram(bus, year, week_day, direction, boarding)
          
          # 儲存圖片
          path = paste0("images/", year - 1911, "/", bus, "/barplot")
          check_path(path)
          main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線', ifelse(direction == 0, '去程', '回程'), ifelse(week_day == '平日', '平日', '假日'), '各', ifelse(boarding, '上', '下'), '車站點票種直方疊圖')
          png(filename = paste0(path, "/", main, ".png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
          tick_type_week_day_direction_histgram(bus, year, week_day, direction, boarding)
          dev.off()
        }
      }
    }
  }
}
```

## 乘坐分鐘盒狀圖(skip)

4*2 list to do

## TPASS運量: 個別路線

```{r}
# 個別TPASS運量
tpass_plot <- function(bus, year.to) {
  months = c("202310", "202311", "202312", generate_months(2024, year.to, 1, 12))
  x_dates <- as.Date(paste0(months, "01"), format = "%Y%m%d")

  tpass = NULL
  for(month_index in months){
    temp = ifelse (is.null(df[[month_index]][[bus]][["交易票種"]]),
            0,
            table(convert_holder_type(df[[month_index]][[bus]][["交易票種"]]))[["TPASS"]])
    tpass = c(tpass, temp)
  }
  
  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = x_dates,
       y = tpass,
       type = "o",
       lwd = 2,
       pch = 16,
       col = "gray",
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(tpass) * 0.9, max(tpass) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  months = as.character(as.numeric(months) - 191100)
  title(main = paste0('112年10月至', year.to - 1911, '年12月', bus, '路線TPASS搭乘次數折線圖'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = x_dates, labels = months, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  text(x = x_dates,
       y = tpass + max(tpass) * 0.02,
       labels = tpass,
       pos = 3,            # 文字顯示在點上方
       cex = 1.5,          # 文字大小
       col = "black"
  )
  
  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = paste0(bus, '路線'), 
         col = "gray", 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}

# 畫到至今為止的圖
for (year in 2024:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    tpass_plot(bus, year)
    
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    main = paste0('112年10月至', year.to - 1911, '年12月', bus, '路線TPASS搭乘次數折線圖')
    png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    tpass_plot(bus, year)
    dev.off()
  }
}
```

## TPASS運量: 總人次

```{r}
# 個別TPASS運量
tpass_total_plot <- function(year.to) {
  months = c("202310", "202311", "202312", generate_months(2024, year.to, 1, 12))
  x_dates <- as.Date(paste0(months, "01"), format = "%Y%m%d")

  tpass_total = data.frame()
  for(bus in buses){
    tpass = NULL
    for(month_index in months){
      temp = ifelse (is.null(df[[month_index]][[bus]][["交易票種"]]),
              0,
              table(convert_holder_type(df[[month_index]][[bus]][["交易票種"]]))[["TPASS"]])
      tpass = c(tpass, temp)
    }
    tpass_total = rbind(tpass_total, tpass)
  }
  tpass_total = unname(apply(tpass_total, 2, sum))
  
  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = x_dates,
       y = tpass_total,
       type = "o",
       lwd = 2,
       pch = 16,
       col = "gray",
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(tpass_total) * 0.9, max(tpass_total) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  months = as.character(as.numeric(months) - 191100)
  title(main = paste0('112年10月至', year.to - 1911, '年12月普悠瑪客運TPASS搭乘次數折線圖'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = x_dates, labels = months, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  text(x = x_dates,
       y = tpass_total + max(tpass_total) * 0.02,
       labels = tpass_total,
       pos = 3,            # 文字顯示在點上方
       cex = 1.5,          # 文字大小
       col = "black"
  )
  
  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = "總人次", 
         col = "gray", 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}

# 畫到至今為止的圖
for (year in 2024:year.to){
# 繪圖 (在 R中呈現)
  tpass_total_plot(year)
  
# 儲存圖片
  path = paste0("images/", year - 1911, "/total/line_chart")
  check_path(path)
  main = paste0('112年10月至', year.to - 1911, '年12月普悠瑪客運TPASS搭乘次數折線圖')
  png(filename = paste0(path, "/", main, ".png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  tpass_total_plot(year)
  dev.off()
}
```


```{r}
end_time = Sys.time()
print(paste0("執行時間: ", round(difftime(end_time, start_time, units = "mins"), 2), " 分鐘"))
```

