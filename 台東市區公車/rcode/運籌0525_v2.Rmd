---
title: "R Notebook"
output: html_notebook
---

# 前情提要



## 合併檔案

```{r}
library(readxl)
library(data.table)
library(dplyr)
library(ggplot2)
library(purrr)
```

### 113年普悠瑪客運

```{r}
# setwd
setwd("C:/Users/user/OneDrive/Documents/運籌報告資料/大數據組需要分析的資料/107-114.03普悠瑪客運_台東市區客運/113")

# 取得所有 Excel 檔案名稱
file_list <- list.files(pattern = ".xlsx")

# 讀取所有 Excel 檔案
df_list <- purrr::map(file_list, ~ readxl::read_excel(.))

# 取得所有檔案中的欄位名稱，並找到所有欄位的並集
all_columns <- Reduce(union, lapply(df_list, names))

# 將每個資料框中的欄位補齊缺少的欄位，並將缺少的欄位填入 NA
df_list <- purrr::map(df_list, function(df) {
  missing_cols <- setdiff(all_columns, names(df))  # 找出缺少的欄位
  df[missing_cols] <- NA  # 為缺少的欄位新增 NA
  return(df[all_columns])  # 確保欄位順序一致
})

# 使用 bind_rows() 合併所有資料框
combined_df_113 <- dplyr::bind_rows(df_list)

head(combined_df_113)
```

### 112年普悠瑪客運

```{r}
# setwd
setwd("C:/Users/user/OneDrive/Documents/運籌報告資料/大數據組需要分析的資料/107-114.03普悠瑪客運_台東市區客運/112")

# 取得所有 Excel 檔案名稱
file_list <- list.files(pattern = ".xlsx")

# 讀取所有 Excel 檔案
df_list <- purrr::map(file_list, ~ readxl::read_excel(.))

# 取得所有檔案中的欄位名稱，並找到所有欄位的並集
all_columns <- Reduce(union, lapply(df_list, names))

# 將每個資料框中的欄位補齊缺少的欄位，並將缺少的欄位填入 NA
df_list <- purrr::map(df_list, function(df) {
  missing_cols <- setdiff(all_columns, names(df))  # 找出缺少的欄位
  df[missing_cols] <- NA  # 為缺少的欄位新增 NA
  return(df[all_columns])  # 確保欄位順序一致
})

# 使用 bind_rows() 合併所有資料框
combined_df_112 <- dplyr::bind_rows(df_list)

head(combined_df_112)
```

### 111年普悠瑪客運

```{r}
# setwd
setwd("C:/Users/user/OneDrive/Documents/運籌報告資料/大數據組需要分析的資料/107-114.03普悠瑪客運_台東市區客運/111")

# 取得所有 Excel 檔案名稱
file_list <- list.files(pattern = ".xlsx")

# 讀取所有 Excel 檔案
df_list <- purrr::map(file_list, ~ readxl::read_excel(.))

# 取得所有檔案中的欄位名稱，並找到所有欄位的並集
all_columns <- Reduce(union, lapply(df_list, names))

# 將每個資料框中的欄位補齊缺少的欄位，並將缺少的欄位填入 NA
df_list <- purrr::map(df_list, function(df) {
  missing_cols <- setdiff(all_columns, names(df))  # 找出缺少的欄位
  df[missing_cols] <- NA  # 為缺少的欄位新增 NA
  return(df[all_columns])  # 確保欄位順序一致
})

# 使用 bind_rows() 合併所有資料框
combined_df_111 <- dplyr::bind_rows(df_list)

head(combined_df_111)
```


### 合併三個資料集

```{r}
combined_df <- bind_rows(combined_df_113, combined_df_112, combined_df_111)

# 檢視合併後的結果
tail(combined_df)
```

## 處理時間變數

```{r}
puyuma <- combined_df %>%
  mutate(上車時間 = as.POSIXct(
    paste0(combined_df$上車交易日期,
           combined_df$上車交易時間),
    format = "%Y%m%d%H%M%S"),
         下車時間 = as.POSIXct(
           paste0(combined_df$下車交易日期,
                  combined_df$下車交易時間),
           format = "%Y%m%d%H%M%S")) %>% 
  mutate(上車交易日期 = as.Date(上車交易日期, format = "%Y%m%d"),
         下車交易日期 = as.Date(下車交易日期, format = "%Y%m%d"))

summary(puyuma$上車時間)
```

## 字型設定: 標楷體

```{r}
windowsFonts(kai = windowsFont("DFKai-SB"))
# theme_set(
#   theme(text = element_text(family = "標楷體", size = 12))
# )
```

## 運量變化圖

### 隨日

```{r}
start_date <- as.POSIXct("2024-05-01")
end_date   <- as.POSIXct("2024-05-31")

# using ggplot2

puyuma %>%
  filter(!is.na(上車時間),
         路線編號 == "9801",
         上車交易日期 >= start_date, 上車交易日期 <= end_date) %>%
  count(上車交易日期, name = "上車人數") %>%
  ggplot(aes(x = 上車交易日期, y = 上車人數)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(size = 2, color = "darkred") +
  geom_text(aes(label = 上車人數), vjust = -1, color = "firebrick", size = 3) +
  scale_x_date(date_breaks = "5 days", date_labels = "%m-%d") +
  labs(
    title = "9801 路線 2024 年 5 月每日上車人數",
    x = "日期",
    y = "上車人數"
  )
```

```{r}
# using plot

df <- puyuma %>%
  filter(!is.na(上車時間),
         路線編號 == "9801",
         上車交易日期 >= start_date, 上車交易日期 <= end_date) %>%
  count(上車交易日期, name = "上車人數")

par(family = "kai")  # 字體與圖寬度設定

plot(df$上車交易日期,
     df$上車人數,
     type = "o",
     col = "blue",
     pch = 16,
     lwd = 2,
     xlab = "日期",
     ylab = "上車人數",
     main = "9801 路線 2024 年 5 月每日上車人數",
     xaxt = "n")

date_ticks <- seq(min(df$上車交易日期), max(df$上車交易日期), by = "5 days")

axis(1, at = date_ticks, labels = format(date_ticks, "%m-%d"))

grid()
```


### 隨月

```{r}
puyuma %>%
  filter(!is.na(上車時間),  # 排除 NA 值
         路線編號 == "9801",
         between(month(上車時間), 3, 12)) %>%  # 用 between() 增加可讀性 %>% 
  count(月份 = month(上車時間), name = "上車人數") %>%  # 直接計數
  ggplot(aes(x = 月份, y = 上車人數)) +
  geom_line(aes(group = 1), color = "steelblue", linewidth = 1) +  # 強制分組
  geom_point(size = 3, color = "darkred") +
  geom_text(aes(label = 上車人數), vjust = -1, color = "firebrick", size = 3) +
  scale_x_continuous(breaks = 3:12,
                     labels = month.abb[3:12]) +  # 用月份縮寫取代數字
  ggtitle("9801 路線 2024 年上車人數隨月份變化")
```

#### 各路線比較

```{r}
puyuma %>%
  filter(!is.na(上車時間),
         between(month(上車時間), 3, 12)) %>%
  count(路線編號, 月份 = month(上車時間), name = "上車人數") %>% 
  ggplot(aes(x = 月份, y = 上車人數, color = 路線編號, group = 路線編號)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3) +
  scale_x_continuous(breaks = 3:12, labels = month.abb[3:12]) +
  labs(
    title = "2024 年不同路線每月上車人數比較",
    x = "月份",
    y = "上車人數",
    color = "路線編號"
  )
```


```{r}
# 設定年份範圍
year.from <- 2022

# 設定月份範圍
month.from <- 1
month.to <- 12

library(lubridate)

# 先開啟圖形裝置
png(paste0("figure/volumebyroute_", year.from - 1911, ".png"),
    width = 30,
    height = 10,
    units = "cm",
    res = 300,
    family = "kai")

# 整理資料
df <- puyuma %>%
  filter(!is.na(上車時間),
         路線編號 %in% c("9801", "9803", "9805", "9806"),  # 選擇特定路線
         year(上車時間) == year.from,  # 選擇特定年份
         between(month(上車時間), 1, 12)) %>%
  count(路線編號, 月份 = month(上車時間), name = "上車人數")

# 轉成 wide 格式，方便畫多條線
df_wide <- tidyr::pivot_wider(df, names_from = 路線編號, values_from = 上車人數)

# 計算總人次
df_wide <- df_wide %>%
  mutate(總人次 = rowSums(select(., -月份), na.rm = TRUE)) %>%
  arrange(月份) %>% 
  select(月份, 總人次, everything())  # 將總人次放在最前面

# 畫圖
mat <- as.matrix(df_wide[,-1]) # 去掉月份欄，剩下各路線人數
months <- df_wide$月份

par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬度設定

matplot(
  months,
  mat,
  type = "o",
  lwd = 2,
  pch = 16,
  lty = 1,
  col = gray.colors(5),
  xlab = "月份",
  ylab = "乘車人次",
  main = paste0(year.from - 1911, '年', month.from, '月至', month.to, '月普悠瑪客運總運量'),
  ylim = c(0, max(na.omit(mat)) * 1.1),
  cex.main = 2,
  cex.lab = 2,
  cex.axis = 1.5,
  cex = 1.5,
  xaxt = "n",
  yaxt = "n",
  bty = "n"
)

# x 軸
axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)

# y 軸
axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)

grid()  # 網格線

# 圖例
legend("topright",
       legend = c("總人次", paste(colnames(mat)[-1], "路線")),
       col = gray.colors(5),
       lwd = 2,
       pch = 16,
       bty = "n",
       inset = c(-0.21, 0),
       xpd = TRUE,
       cex = 1.5)

dev.off()
```

