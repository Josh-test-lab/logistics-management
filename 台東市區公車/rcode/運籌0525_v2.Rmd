---
title: "R Notebook"
output: html_notebook
---

# 畫圖

## 合併檔案

```{r}
library(readxl)
library(data.table)
library(dplyr)
library(ggplot2)
library(purrr)

# setwd
setwd("C:/Users/user/OneDrive/Documents/運籌報告資料/期中資料集_台東市區路線/普悠瑪客運 11303~11403")

# 取得所有 Excel 檔案名稱
file_list <- list.files(pattern = ".xlsx")

# 讀取所有 Excel 檔案
df_list <- purrr::map(file_list, ~ readxl::read_excel(.))

# 取得所有檔案中的欄位名稱，並找到所有欄位的並集
all_columns <- Reduce(union, lapply(df_list, names))

# 將每個資料框中的欄位補齊缺少的欄位，並將缺少的欄位填入 NA
df_list <- purrr::map(df_list, function(df) {
  missing_cols <- setdiff(all_columns, names(df))  # 找出缺少的欄位
  df[missing_cols] <- NA  # 為缺少的欄位新增 NA
  return(df[all_columns])  # 確保欄位順序一致
})

# 使用 bind_rows() 合併所有資料框
combined_df <- dplyr::bind_rows(df_list)

# 檢視合併後的結果
head(combined_df)
```

## 處理時間變數

```{r}
puyuma <- combined_df %>%
  mutate(上車時間 = as.POSIXct(
    paste0(combined_df$上車交易日期,
           combined_df$上車交易時間),
    format = "%Y%m%d%H%M%S"),
         下車時間 = as.POSIXct(
           paste0(combined_df$下車交易日期,
                  combined_df$下車交易時間),
           format = "%Y%m%d%H%M%S")) %>% 
  mutate(上車交易日期 = as.Date(上車交易日期, format = "%Y%m%d"),
         下車交易日期 = as.Date(下車交易日期, format = "%Y%m%d"))
```  

## 字型設定: 標楷體

```{r}
windowsFonts("標楷體" = windowsFont("DFKai-SB"))
theme_set(
  theme(text = element_text(family = "標楷體", size = 12))
)
```


## 運量變化圖

### 隨日

```{r}
start_date <- as.POSIXct("2024-05-01")
end_date   <- as.POSIXct("2024-05-31")

puyuma %>%
  filter(!is.na(上車時間),
         路線編號 == "9801",
         上車交易日期 >= start_date, 上車交易日期 <= end_date) %>%
  count(上車交易日期, name = "上車人數") %>%
  ggplot(aes(x = 上車交易日期, y = 上車人數)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(size = 2, color = "darkred") +
  geom_text(aes(label = 上車人數), vjust = -1, color = "firebrick", size = 3) +
  scale_x_date(date_breaks = "5 days", date_labels = "%m-%d") +
  labs(
    title = "9801 路線 2024 年 5 月每日上車人數",
    x = "日期",
    y = "上車人數"
  )
```

### 隨月

```{r}
puyuma %>%
  filter(!is.na(上車時間),  # 排除 NA 值
         路線編號 == "9801",
         between(month(上車時間), 3, 12)) %>%  # 用 between() 增加可讀性 %>% 
  count(月份 = month(上車時間), name = "上車人數") %>%  # 直接計數
  ggplot(aes(x = 月份, y = 上車人數)) +
  geom_line(aes(group = 1), color = "steelblue", linewidth = 1) +  # 強制分組
  geom_point(size = 3, color = "darkred") +
  geom_text(aes(label = 上車人數), vjust = -1, color = "firebrick", size = 3) +
  scale_x_continuous(breaks = 3:12,
                     labels = month.abb[3:12]) +  # 用月份縮寫取代數字
  ggtitle("9801 路線 2024 年上車人數隨月份變化")
```

#### 各路線比較

```{r}
puyuma %>%
  filter(!is.na(上車時間),
         between(month(上車時間), 3, 12)) %>%
  count(路線編號, 月份 = month(上車時間), name = "上車人數") %>% 
  ggplot(aes(x = 月份, y = 上車人數, color = 路線編號, group = 路線編號)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3) +
  scale_x_continuous(breaks = 3:12, labels = month.abb[3:12]) +
  labs(
    title = "2024 年不同路線每月上車人數比較",
    x = "月份",
    y = "上車人數",
    color = "路線編號"
  )
```

