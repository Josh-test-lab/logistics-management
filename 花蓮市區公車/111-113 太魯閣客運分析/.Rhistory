year.from = 2022
year.to = 2024
month.from = 1
month.to = 12
months = generate_months(year.from, year.to, month.from, month.to)
combined_df = data.frame()
for (month_index in months) {
for (bus_index in buses) {
combined_df = rbind(combined_df, df[[month_index]][[bus_index]])
}
}
combined_df$BoardingTime = ymd_hms(combined_df$BoardingTime)
mytable <- table(year(combined_df$BoardingTime), combined_df$RouteName)
addmargins(mytable, margin = 2)
library(tidyverse)
library(reshape2)  # 用於數據重塑
all_year_stations_heatmap = function(bus, year_index) {
processed_data <- combined_df %>%
filter(RouteName == bus,
year(BoardingTime) == year_index,
Direction == 0,
) %>%
filter(DeboardingStopName != '-99') %>%
select(BoardingStopName, DeboardingStopName) %>%
count(BoardingStopName, DeboardingStopName) %>%
arrange(desc(n))
#heatmap(table(processed_data$BoardingStopName, processed_data$DeboardingStopName),
#        Rowv = NA, Colv = NA,
#        scale = "column",
#        margins = c(5, 10),
#        xlab = "下車站點",
#        ylab = "上車站點",
#        main = "上車招呼站與下車招呼站熱圖")
# 原始數據處理流程 (保持不變)
p = ggplot(processed_data, aes(x = BoardingStopName, y = DeboardingStopName)) +
geom_tile(aes(fill = n), color = "white") +
#geom_text(aes(label = n), color = "black", size = 3) +  # 顯示數值標籤
scale_fill_gradient(low = "white", high = "black") +
labs(
title = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖"),
x = "下車站點",
y = "上車站點",
fill = "搭乘次數"
) +
theme_minimal(base_size = 20) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1)  # X軸標籤傾斜
)
# 儲存圖片
path = paste0("images/", year_index - 1911, "/", bus, "/heatmap")
check_path(path)
img_filename = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖")
ggsave(filename = paste0(path, "/", img_filename, ".png"), bg = "white", height = 8.25,width = 13.79, plot = p)
}
for (year_index in year.from:year.to){
for (bus in buses){
all_year_stations_heatmap(bus, year_index)
}
}
## 上/下車招呼站分佈
#combined_df %>%
#  filter(RouteName == '301') %>%
#  count(DeboardingStopName) %>%
#  arrange(desc(n)) %>%
#  filter(n > 100) %>%
#  filter(DeboardingStopName != '-99') %>%
#  ggplot(aes(x = reorder(DeboardingStopName, n), y = n)) +
#  geom_bar(stat = "identity") +
#  coord_flip() +
#  labs(title = "301 下車站點分佈",
#       x = "下車站點",
#       y = "搭乘次數") +
#  theme_minimal() +
#  theme(axis.text.x = element_text(angle = 45, hjust = 1))
end_time = Sys.time()
print(paste0('Cost time: ', end_time - start_time, ' minutes'))
# 運量概括 by 俊典的 code
month.from = 1
month.to = 12
months = generate_months(year.from, year.to, month.from, month.to)
combined_df = data.frame()
for (month_index in months) {
for (bus_index in buses) {
combined_df = rbind(combined_df, df[[month_index]][[bus_index]])
}
}
combined_df$BoardingTime = ymd_hms(combined_df$BoardingTime)
mytable <- table(year(combined_df$BoardingTime) - 1911, combined_df$RouteName)
addmargins(mytable, margin = 2)
prop.table(mytable, margin = 1) %>% round(2)
# 數量資料（轉成 data frame）
count_df <- as.data.frame(mytable) %>% rename(年份 = Var1, 路線 = Var2, 數量 = Freq)
# 比例資料
prop_df <- prop.table(mytable, margin = 1) %>% as.data.frame() %>% rename(年份 = Var1, 路線 = Var2, 比例 = Freq)
# 合併 數量 和 比例
combined_bar_df <- left_join(count_df, prop_df, by = c("年份", "路線"))
# 把 年份 轉成數值（避免 ggplot 軸錯亂）
combined_bar_df$年份 <- as.numeric(as.character(combined_bar_df$年份))
# 總量（折線圖資料）
total_df <- rowSums(mytable) %>%
as.data.frame() %>%
rename(總量 = ".") %>%
mutate(年份 = as.numeric(rownames(.)))
img_filename = paste0(year.from - 1911, "年至", year.to - 1911, "年花蓮市區客運運量趨勢")
# 繪圖
ggplot(combined_bar_df, aes(x = 年份, y = 數量, fill = 路線)) +
geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
geom_text(aes(label = scales::percent(比例, accuracy = 0.1)),
position = position_dodge(width = 0.9),
vjust = -0.5, size = 3) +
geom_line(data = total_df, aes(x = 年份, y = 總量),
inherit.aes = FALSE, color = "black", linewidth = 1) +
geom_point(data = total_df, aes(x = 年份, y = 總量),
inherit.aes = FALSE, color = "black") +
scale_fill_grey(start = 0.3, end = 0.8) +
labs(title = img_filename,
y = "搭乘次數", x = "") +
theme_minimal()
# 儲存圖片
path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/total/barplot")
check_path(path)
img_filename = paste0(year.from - 1911, "年至", year.to - 1911, "年花蓮市區客運運量趨勢")
ggsave(filename = paste0(path, "/", img_filename, ".png"), bg = "white")
# library
library(xml2)
library(data.table)
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
## 大家都搭去哪裡 by 易軒
# (去程，direction = 0; 回程，direction = 1)
year.from = 2022
year.to = 2024
month.from = 1
month.to = 12
months = generate_months(year.from, year.to, month.from, month.to)
combined_df = data.frame()
for (month_index in months) {
for (bus_index in buses) {
combined_df = rbind(combined_df, df[[month_index]][[bus_index]])
}
}
combined_df$BoardingTime = ymd_hms(combined_df$BoardingTime)
mytable <- table(year(combined_df$BoardingTime), combined_df$RouteName)
addmargins(mytable, margin = 2)
library(tidyverse)
library(reshape2)  # 用於數據重塑
all_year_stations_heatmap = function(bus, year_index) {
processed_data <- combined_df %>%
filter(RouteName == bus,
year(BoardingTime) == year_index,
Direction == 0,
) %>%
filter(DeboardingStopName != '-99') %>%
select(BoardingStopName, DeboardingStopName) %>%
count(BoardingStopName, DeboardingStopName) %>%
arrange(desc(n))
#heatmap(table(processed_data$BoardingStopName, processed_data$DeboardingStopName),
#        Rowv = NA, Colv = NA,
#        scale = "column",
#        margins = c(5, 10),
#        xlab = "下車站點",
#        ylab = "上車站點",
#        main = "上車招呼站與下車招呼站熱圖")
# 原始數據處理流程 (保持不變)
p = ggplot(processed_data, aes(x = DeboardingStopName, y = BoardingStopName)) +
geom_tile(aes(fill = n), color = "white") +
#geom_text(aes(label = n), color = "black", size = 3) +  # 顯示數值標籤
scale_fill_gradient(low = "white", high = "black") +
labs(
title = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖"),
x = "下車站點",
y = "上車站點",
fill = "搭乘次數"
) +
theme_minimal(base_size = 20) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1)  # X軸標籤傾斜
)
# 儲存圖片
path = paste0("images/", year_index - 1911, "/", bus, "/heatmap")
check_path(path)
img_filename = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖")
ggsave(filename = paste0(path, "/", img_filename, ".png"), bg = "white", height = 8.25,width = 13.79, plot = p)
}
for (year_index in year.from:year.to){
for (bus in buses){
all_year_stations_heatmap(bus, year_index)
}
}
## 大家都搭去哪裡 by 易軒
# (去程，direction = 0; 回程，direction = 1)
year.from = 2022
year.to = 2024
month.from = 1
month.to = 12
months = generate_months(year.from, year.to, month.from, month.to)
combined_df = data.frame()
for (month_index in months) {
for (bus_index in buses) {
combined_df = rbind(combined_df, df[[month_index]][[bus_index]])
}
}
combined_df$BoardingTime = ymd_hms(combined_df$BoardingTime)
mytable <- table(year(combined_df$BoardingTime), combined_df$RouteName)
addmargins(mytable, margin = 2)
library(tidyverse)
library(reshape2)  # 用於數據重塑
all_year_stations_heatmap = function(bus, year_index) {
processed_data <- combined_df %>%
filter(RouteName == bus,
year(BoardingTime) == year_index
) %>%
filter(DeboardingStopName != '-99') %>%
select(BoardingStopName, DeboardingStopName) %>%
count(BoardingStopName, DeboardingStopName) %>%
arrange(desc(n))
#heatmap(table(processed_data$BoardingStopName, processed_data$DeboardingStopName),
#        Rowv = NA, Colv = NA,
#        scale = "column",
#        margins = c(5, 10),
#        xlab = "下車站點",
#        ylab = "上車站點",
#        main = "上車招呼站與下車招呼站熱圖")
# 原始數據處理流程 (保持不變)
p = ggplot(processed_data, aes(x = DeboardingStopName, y = BoardingStopName)) +
geom_tile(aes(fill = n), color = "white") +
#geom_text(aes(label = n), color = "black", size = 3) +  # 顯示數值標籤
scale_fill_gradient(low = "white", high = "black") +
labs(
title = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖"),
x = "下車站點",
y = "上車站點",
fill = "搭乘次數"
) +
theme_minimal(base_size = 20) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1)  # X軸標籤傾斜
)
# 儲存圖片
path = paste0("images/", year_index - 1911, "/", bus, "/heatmap")
check_path(path)
img_filename = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖")
ggsave(filename = paste0(path, "/", img_filename, ".png"), bg = "white", height = 8.25,width = 13.79, plot = p)
}
for (year_index in year.from:year.to){
for (bus in buses){
all_year_stations_heatmap(bus, year_index)
}
}
# library
library(xml2)
library(data.table)
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
## 大家都搭去哪裡 by 易軒
# (去程，direction = 0; 回程，direction = 1)
year.from = 2022
year.to = 2024
month.from = 1
month.to = 12
months = generate_months(year.from, year.to, month.from, month.to)
combined_df = data.frame()
for (month_index in months) {
for (bus_index in buses) {
combined_df = rbind(combined_df, df[[month_index]][[bus_index]])
}
}
combined_df$BoardingTime = ymd_hms(combined_df$BoardingTime)
mytable <- table(year(combined_df$BoardingTime), combined_df$RouteName)
addmargins(mytable, margin = 2)
library(tidyverse)
library(reshape2)  # 用於數據重塑
all_year_stations_heatmap = function(bus, year_index) {
processed_data <- combined_df %>%
filter(RouteName == bus,
year(BoardingTime) == year_index
) %>%
filter(DeboardingStopName != '-99') %>%
select(BoardingStopName, DeboardingStopName) %>%
count(BoardingStopName, DeboardingStopName) %>%
arrange(desc(n))
#heatmap(table(processed_data$BoardingStopName, processed_data$DeboardingStopName),
#        Rowv = NA, Colv = NA,
#        scale = "column",
#        margins = c(5, 10),
#        xlab = "下車站點",
#        ylab = "上車站點",
#        main = "上車招呼站與下車招呼站熱圖")
# 原始數據處理流程 (保持不變)
p = ggplot(processed_data, aes(x = DeboardingStopName, y = BoardingStopName)) +
geom_tile(aes(fill = n), color = "white") +
#geom_text(aes(label = n), color = "black", size = 3) +  # 顯示數值標籤
scale_fill_gradient(low = "white", high = "black") +
labs(
title = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖"),
x = "下車站點",
y = "上車站點",
fill = "搭乘次數"
) +
theme_minimal(base_size = 20) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1)  # X軸標籤傾斜
)
# 儲存圖片
path = paste0("images/", year_index - 1911, "/", bus, "/heatmap")
check_path(path)
img_filename = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖")
ggsave(filename = paste0(path, "/", img_filename, ".png"), bg = "white", height = 8.25,width = 13.79, plot = p)
}
for (year_index in year.from:year.to){
for (bus in buses){
all_year_stations_heatmap(bus, year_index)
}
}
# library
library(xml2)
library(data.table)
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
## 大家都搭去哪裡 by 易軒
# (去程，direction = 0; 回程，direction = 1)
year.from = 2022
year.to = 2024
month.from = 1
month.to = 12
months = generate_months(year.from, year.to, month.from, month.to)
combined_df = data.frame()
for (month_index in months) {
for (bus_index in buses) {
combined_df = rbind(combined_df, df[[month_index]][[bus_index]])
}
}
combined_df$BoardingTime = ymd_hms(combined_df$BoardingTime)
mytable <- table(year(combined_df$BoardingTime), combined_df$RouteName)
addmargins(mytable, margin = 2)
library(tidyverse)
library(reshape2)  # 用於數據重塑
all_year_stations_heatmap = function(bus, year_index) {
processed_data <- combined_df %>%
filter(RouteName == bus,
year(BoardingTime) == year_index
) %>%
filter(DeboardingStopName != '-99') %>%
select(BoardingStopName, DeboardingStopName) %>%
count(BoardingStopName, DeboardingStopName) %>%
arrange(desc(n))
#heatmap(table(processed_data$BoardingStopName, processed_data$DeboardingStopName),
#        Rowv = NA, Colv = NA,
#        scale = "column",
#        margins = c(5, 10),
#        xlab = "下車站點",
#        ylab = "上車站點",
#        main = "上車招呼站與下車招呼站熱圖")
# 原始數據處理流程 (保持不變)
p = ggplot(processed_data, aes(x = DeboardingStopName, y = BoardingStopName)) +
geom_tile(aes(fill = n), color = "white") +
#geom_text(aes(label = n), color = "black", size = 3) +  # 顯示數值標籤
scale_fill_gradient(low = "white", high = "black") +
labs(
title = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖"),
x = "下車站點",
y = "上車站點",
fill = "搭乘次數"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1)  # X軸標籤傾斜
)
# 儲存圖片
path = paste0("images/", year_index - 1911, "/", bus, "/heatmap")
check_path(path)
img_filename = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖")
ggsave(filename = paste0(path, "/", img_filename, ".png"), bg = "white", height = 8.25,width = 13.79, plot = p)
}
for (year_index in year.from:year.to){
for (bus in buses){
all_year_stations_heatmap(bus, year_index)
}
}
## 大家都搭去哪裡 by 易軒
# (去程，direction = 0; 回程，direction = 1)
year.from = 2022
year.to = 2024
month.from = 1
month.to = 12
months = generate_months(year.from, year.to, month.from, month.to)
combined_df = data.frame()
for (month_index in months) {
for (bus_index in buses) {
combined_df = rbind(combined_df, df[[month_index]][[bus_index]])
}
}
combined_df$BoardingTime = ymd_hms(combined_df$BoardingTime)
mytable <- table(year(combined_df$BoardingTime), combined_df$RouteName)
addmargins(mytable, margin = 2)
library(tidyverse)
library(reshape2)  # 用於數據重塑
all_year_stations_heatmap = function(bus, year_index) {
processed_data <- combined_df %>%
filter(RouteName == bus,
year(BoardingTime) == year_index
) %>%
filter(DeboardingStopName != '-99') %>%
select(BoardingStopName, DeboardingStopName) %>%
count(BoardingStopName, DeboardingStopName) %>%
arrange(desc(n))
#heatmap(table(processed_data$BoardingStopName, processed_data$DeboardingStopName),
#        Rowv = NA, Colv = NA,
#        scale = "column",
#        margins = c(5, 10),
#        xlab = "下車站點",
#        ylab = "上車站點",
#        main = "上車招呼站與下車招呼站熱圖")
# 原始數據處理流程 (保持不變)
p = ggplot(processed_data, aes(x = DeboardingStopName, y = BoardingStopName)) +
geom_tile(aes(fill = n), color = "white") +
#geom_text(aes(label = n), color = "black", size = 3) +  # 顯示數值標籤
scale_fill_gradient(low = "white", high = "black") +
labs(
title = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖"),
x = "下車站點",
y = "上車站點",
fill = "搭乘次數"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1)  # X軸標籤傾斜
)
# 儲存圖片
path = paste0("images/", year_index - 1911, "/", bus, "/heatmap")
check_path(path)
img_filename = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖")
ggsave(filename = paste0(path, "/", img_filename, ".png"), bg = "white", height = 8.25,width = 13.79, plot = p)
}
for (year_index in year.from:year.to){
for (bus in buses){
all_year_stations_heatmap(bus, year_index)
}
}
# library
library(xml2)
library(data.table)
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
## 大家都搭去哪裡 by 易軒
# (去程，direction = 0; 回程，direction = 1)
year.from = 2022
year.to = 2024
month.from = 1
month.to = 12
months = generate_months(year.from, year.to, month.from, month.to)
combined_df = data.frame()
for (month_index in months) {
for (bus_index in buses) {
combined_df = rbind(combined_df, df[[month_index]][[bus_index]])
}
}
combined_df$BoardingTime = ymd_hms(combined_df$BoardingTime)
mytable <- table(year(combined_df$BoardingTime), combined_df$RouteName)
addmargins(mytable, margin = 2)
library(tidyverse)
library(reshape2)  # 用於數據重塑
all_year_stations_heatmap = function(bus, year_index) {
processed_data <- combined_df %>%
filter(RouteName == bus,
year(BoardingTime) == year_index
) %>%
filter(DeboardingStopName != '-99') %>%
select(BoardingStopName, DeboardingStopName) %>%
count(BoardingStopName, DeboardingStopName) %>%
arrange(desc(n))
#heatmap(table(processed_data$BoardingStopName, processed_data$DeboardingStopName),
#        Rowv = NA, Colv = NA,
#        scale = "column",
#        margins = c(5, 10),
#        xlab = "下車站點",
#        ylab = "上車站點",
#        main = "上車招呼站與下車招呼站熱圖")
# 原始數據處理流程 (保持不變)
p = ggplot(processed_data, aes(x = DeboardingStopName, y = BoardingStopName)) +
geom_tile(aes(fill = n), color = "white") +
#geom_text(aes(label = n), color = "black", size = 3) +  # 顯示數值標籤
scale_fill_gradient(low = "white", high = "black") +
labs(
title = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖"),
x = "下車站點",
y = "上車站點",
fill = "搭乘次數"
) +
theme_minimal(base_size = 15) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1)  # X軸標籤傾斜
)
# 儲存圖片
path = paste0("images/", year_index - 1911, "/", bus, "/heatmap")
check_path(path)
img_filename = paste0(year_index - 1911, "年路線", bus, "上下車站點熱力圖")
ggsave(filename = paste0(path, "/", img_filename, ".png"), bg = "white", height = 8.25,width = 13.79, plot = p)
}
for (year_index in year.from:year.to){
for (bus in buses){
all_year_stations_heatmap(bus, year_index)
}
}
