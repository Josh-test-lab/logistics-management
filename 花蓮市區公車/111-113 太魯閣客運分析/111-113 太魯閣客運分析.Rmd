---
title: "2024 bus"
output: html_notebook
author: "Hsu, Yao-Chih"
date: "114-05-25"
---

本程式碼適用於分析111-113年花蓮太魯閣客運所提供的 .xml 資料檔案。


# 參數設定
```{r}
# library
library(xml2)
library(data.table)
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
```

```{r}
# function
start_time = Sys.time()

# load .xml file function
xml_loader <- function(path){
  xml_data <- read_xml(path)
  return(xml_data)
}

# transform to data frame by RouteName
get_xml_text <- function(node, path) {
  result <- xml_find_first(node, path)
  if (length(result) == 0 || is.na(result)) return(NA_character_)
  xml_text(result, trim = TRUE)
}

xml_to_dataframe <- function(xml_data){
  tickets <- xml_find_all(xml_data, ".//BusICTicket")
  tickets_str <- vapply(tickets, as.character, character(1))

  ticket_data <- rbindlist(lapply(tickets_str, function(ticket_str) {
    ticket <- read_xml(ticket_str)
    list(
      ID = get_xml_text(ticket, "ID"),
      IDType = get_xml_text(ticket, "IDType"),
      HolderType = get_xml_text(ticket, "HolderType"),
      TicketType = get_xml_text(ticket, "TicketType"),
      SubTicketType = get_xml_text(ticket, "SubTicketType"),
      PlateNumber = get_xml_text(ticket, "PlateNumber"),
      RouteUID = get_xml_text(ticket, "RouteUID"),
      RouteName = get_xml_text(ticket, "RouteName"),
      SubRouteUID = get_xml_text(ticket, "SubRouteUID"),
      SubRouteName = get_xml_text(ticket, "SubRouteName"),
      Direction = get_xml_text(ticket, "Direction"),
      FarePricingType = get_xml_text(ticket, "FarePricingType"),
      StopOrStation = get_xml_text(ticket, "StopOrStation"),
      BoardingStopUID = get_xml_text(ticket, ".//BoardingStopUID"),
      BoardingStopName = get_xml_text(ticket, ".//BoardingStopName"),
      BoardingStopSequence = get_xml_text(ticket, ".//BoardingStopSequence"),
      BoardingTime = get_xml_text(ticket, ".//BoardingTime"),
      DeboardingStopUID = get_xml_text(ticket, ".//DeboardingStopUID"),
      DeboardingStopName = get_xml_text(ticket, ".//DeboardingStopName"),
      DeboardingStopSequence = get_xml_text(ticket, ".//DeboardingStopSequence"),
      DeboardingTime = get_xml_text(ticket, ".//DeboardingTime"),
      Price = get_xml_text(ticket, "Price"),
      Discount = get_xml_text(ticket, "Discount"),
      TransferCode = get_xml_text(ticket, "TransferCode"),
      DiscountInfo = get_xml_text(ticket, "DiscountInfo"),
      PaymentPrice = get_xml_text(ticket, "PaymentPrice")
    )
  }), fill = TRUE)
  
  return(ticket_data)
}

# loader
loader <- function(path){
  xml_data = data.frame()
  for (i in 1:length(path[[1]])){
    xml_raw_data = xml_loader(path=path[[1]][i])
    
    xml_data <- rbind(xml_data, xml_to_dataframe(xml_raw_data))
  }
  
  data <- xml_data %>%
    group_by(RouteName) %>%
    group_split() %>% 
    as.list()
  names(data) <- sapply(data, function(df) unique(df$RouteName))  # list name
  
  return(data)
}

# simple summary for every variables
data_summary <- function(df){
  df_summary = list()
  pb <- txtProgressBar(min = 0, max = length(months), style = 3)
  for (month_index in 1:length(months)){
    df_summary[[months[month_index]]] <- lapply(df[[month_index]], function(data) {
      lapply(names(data), function(col) {
        data %>% count(.data[[col]])
      }) |> setNames(names(data))
    })
    names(df_summary[[months[month_index]]]) <- names(df[[month_index]])
    setTxtProgressBar(pb, month_index)
  }
  close(pb)
  return(df_summary)
}

# check the amounts of weekends and weekdays
monthly_weekday_and_weekend <- function(year, month){
  # build all dates 
  dates <- seq(ymd(sprintf("%d-%02d-01", year, month)),
               ceiling_date(ymd(sprintf("%d-%02d-01", year, month)), "month") - days(1),
               by = "day"
               )
  
  # is it weekend?
  is_weekend <- wday(dates) %in% c(1, 7)  # 1: Sunday, 7: Saturday
  
  # output
  result <- table(ifelse(is_weekend, "weekend", "weekday")) %>% data.frame()
  return(result)
}

# check the save path
check_path <- function(path) {
  if (!dir.exists(path)) {
    dir.create(path, recursive = TRUE, showWarnings = FALSE)
  }
}

# generate the specified month interval
generate_months <- function(year.from, year.to, month.from = 1, month.to = 12) {
  months = unlist(lapply(year.from:year.to, function(y) {sprintf("%04d%02d", y, month.from:month.to)}))
  return(months)
}

# convert HolderType to common ticket type
convert_holder_type <- function(types) {
  map <- c(
    "A"   = "一般票",
    "B"   = "學生票",
    "C01" = "敬老優待票",
    "C02" = "愛心優待票",
    "C09" = "其他優待票",
    "D"   = "員工票"
  )
  result <- map[types]
  result[is.na(result)] <- "無法辨識"
  return(result)
}
```

```{r}
# config
year.from = 2022  # 西元
year.to = 2024
month.from = 1
month.to = 12

windowsFonts(kai = windowsFont("Microsoft JhengHei"))

# 檔案路徑
base_path <- "../../大數據組需要分析的資料/107-11403-花蓮-太魯閣客運_市區客運"
months <- generate_months(year.from, year.to, month.from, month.to)
roc_years <- as.character(as.integer(substr(months, 1, 4)) - 1911)
paths <- unlist(mapply(function(ym, roc) {
  folder <- sprintf("%s_ic_HUA_0412_01", ym)
  files <- sprintf("%s_ic_HUA_0412_0%d.xml", ym, 1:3)
  file.path(base_path, roc, folder, files)
}, ym = months, roc = roc_years, SIMPLIFY = FALSE))

# 將票證資料轉為資料框，以列表呈現
counter = 1
pb <- txtProgressBar(min = 0, max = length(paths), style = 3)
df = list()

for (month_index in seq(1, length(paths), by = 3)){
  path = paths[month_index:min(month_index + 2, length(paths))]
  df[[months[counter]]] = loader(path)
  
  setTxtProgressBar(pb, counter * 3)
  counter = counter + 1
}
close(pb)

buses = names(df[[1]])

# 檢視前幾筆資料
head(df[[1]][[1]])
str(df[[1]])
```

```{r}
# TPASS for 11210-11302
if (2023 %in% year.from:year.to){
  pb <- txtProgressBar(min = 0, max = length(paths), style = 3)
  
  # 檔案路徑
  base_path <- "../../大數據組需要分析的資料/107-11403-花蓮-太魯閣客運_市區客運/112/壓縮檔/11210-11302 TPASS資料"
  months <- c("202310", "202311", "202312", "202401", "202402")
  paths <- unlist(mapply(function(ym) {
    folder <- sprintf("%s_ic_HUA_0412_01", ym)
    files <- sprintf("%s_ic_HUA_0412_0%d.xml", ym, 1:3)
    file.path(base_path, folder, files)
  }, ym = months, SIMPLIFY = FALSE))
  
  counter = 1
  for (month_index in seq(1, length(paths), by = 3)){
    path = paths[month_index:min(month_index + 2, length(paths))]
    
    xml_data = data.frame()
    for (i in 1:length(path[[1]])){
      xml_raw_data = xml_loader(path=path[[1]][i])
      
      xml_data <- rbind(xml_data, xml_to_dataframe(xml_raw_data))
    }
  
    data <- xml_data %>%
      group_by(RouteName) %>%
      group_split() %>% 
      as.list()
    names(data) <- sapply(data, function(df) unique(df$RouteName))
    
    
    # 存入個別車輛資料
    for (bus in buses){
      df[[months[counter]]][[bus]] = data[[bus]]
    }
    
    setTxtProgressBar(pb, counter * 3)
    counter = counter + 1
  }
  
  close(pb)
}
```

```{r}
# 整理日期，找出星期幾
# 新增 Weekday 欄位

# 上車分鐘與下車分鐘
# 上車分鐘指該天上車時間權全換為分鐘，如 21 小時 31 分 15 秒為 21 × 60 + 31 = 1291 分鐘
# 新增 BoardingTimeInMinutes 和 DeboardingTimeInMinutes 欄位

# 搭乘時間
# 是指下車分鐘減去上車分鐘

month.from = 1
month.to = 12
months = generate_months(year.from, year.to, month.from, month.to)

for (month_index in months) {
  for (bus_index in buses) {
    df[[month_index]][[bus_index]] <- df[[month_index]][[bus_index]] |>
      mutate(
        BoardingParsed = if_else(
          BoardingTime == "0000-00-00 00:00:00",
          as.POSIXct(NA),
          suppressWarnings(ymd_hms(BoardingTime))
        ),
        DeboardingParsed = if_else(
          DeboardingTime == "0000-00-00 00:00:00",
          as.POSIXct(NA),
          suppressWarnings(ymd_hms(DeboardingTime))
        ),
        
        # 星期幾
        Weekday = weekdays(coalesce(BoardingParsed, DeboardingParsed)),
        
        # 上車分鐘
        BoardingTimeInMinutes = hour(BoardingParsed) * 60 + minute(BoardingParsed) + second(BoardingParsed) / 60,
        
        # 下車分鐘
        DeboardingTimeInMinutes = hour(DeboardingParsed) * 60 + minute(DeboardingParsed) + second(DeboardingParsed) / 60,
        
        # 搭乘時間
        TravelTime = DeboardingTimeInMinutes - BoardingTimeInMinutes
      ) |>
      select(-BoardingParsed, -DeboardingParsed)  # 清除中間欄位
  }
}
```



```{r}
# 儲存至 csv 檔案
path = paste0("datasets")
check_path(path)

for(year in year.from:year.to){
  months = generate_months(year, year, month.from, month.to)
  df_save = data.frame()
  for (month_index in months){
    for(bus in buses){
      df_save = rbind(df_save, df[[month_index]][[bus]])
    }
  }
  write.csv(df_save, file = paste0(path, "/太魯閣客運_", year, ".csv"), row.names = FALSE, fileEncoding = "UTF-8")
}
```


```{r}
# variables
names(df[[1]][[1]])
```

| 欄位名稱                | 中文名稱       | 說明                                           |
| ------------------------| -------------- | --------------------------------------------   |
| `ID`                    | 票證識別碼     | 資料筆唯一識別碼，用於區隔每一筆旅次或票證紀錄。                  |   
| `IDType`                | 識別碼類型     | 識別碼類型，如車牌編號、票證序號等，指明 ID 的來源或格式。         |     
| `HolderType`            | 票證持有者類   | 票證持有者類型，例如一般民眾、學生、敬老卡等。                    | 
| `TicketType`            | 票種           | 如單程票、電子票證、日票等，用以區分不同票價方案。                |    
| `SubTicketType`         | 子票種         | 子票種／細分類，如半價、愛心票、團體票等，為 TicketType 的細部補充|。     
| `PlateNumber`           | 車輛牌號       | 車輛牌照號碼，標示該筆旅次所搭乘的車輛。                       |  
| `RouteUID`              | 路線識別碼     | 路線全域唯一識別碼，用於串接不同 API 時對應相同路線。         | 
| `RouteName`             | 路線名稱       |  路線名稱，例如「302 花蓮－太魯閣」。                        | 
| `SubRouteUID`           | 附屬路線識別碼 | 編碼原則：前四碼主路線，第五碼正副路線，第六碼去返程。             |    
| `SubRouteName`          | 附屬路線名稱   | 附屬路線名稱，對應 SubRouteUID 的文字描述。               |  
| `Direction`             | 去／返程方向   | 通常 0 或 1 表示去程，2 或 3 表示返程。                  |  
| `FarePricingType`       | 計費方式       | 如「區間計費」、「里程計費」、「階梯票價」等。                    |  
| `StopOrStation`         | 站點類型       | 表示站牌 (Stop) 或站位 (Station)，用於票證 OD 分析對應的資料層級。| 
| `BoardingStopUID`       | 上車站點識別碼 | 上車站點識別碼，對應 StopOrStation。                   | 
| `BoardingStopName`      | 上車站名       | 上車站名稱。                                      
| `BoardingStopSequence`  | 上車站序       | 上車站在整條路線中的站序（第幾站）。                         |  
| `BoardingTime`          | 上車時間       | 上車時間（ISO 8601 格式）。                         |  
| `DeboardingStopUID`     | 下車站點識別碼 | 下車站點識別碼。                                    | 
| `DeboardingStopName`    | 下車站名       | 下車站名稱。                                       
| `DeboardingStopSequence`| 下車站序       | 下車站在整條路線中的站序。                              | 
| `DeboardingTime`        | 下車時間       | 下車時間（ISO 8601 格式）。                         | 
| `Price`                 | 原始票價       | 計算後之票價（未含折扣）。                              |  
| `Discount`              | 折扣           | 折扣比例或金額，例如「半價」、「８折」。                       |  
| `TransferCode`          | 轉乘代碼       | 轉乘優惠代碼，用於標示可否轉乘及轉乘時限等規則。                   | 
| `DiscountInfo`          | 折扣說明       | 折扣補充說明文字，補充 Discount 欄位的詳細條件。            | 
| `PaymentPrice`          | 實付金額       | 實際支付金額（Price 扣除 Discount 後）。             |  

| 欄位名稱                | 資料來源                   | 變數
| ------------------------| -------------------------- | ----------------------------------------- |
| `ID`                    | ticp.motc.gov.tw           | #########################################################################|
| `IDType`                | ticp.motc.gov.tw           | EasyCard、PaymentID、iPASS、icash|
| `HolderType`            | ticp.motc.gov.tw           | A、B、C01、C02、C09 (???|
| `TicketType`            | 110traffic.hl.gov.tw       | 1、4 (???|
| `SubTicketType`         | ticp.motc.gov.tw           | HUA-199、HUA-399(花蓮通勤月票)|
| `PlateNumber`           | ticp.motc.gov.tw           | 009-FV、010-FV、011-FV、075-FV、076-FV、
                                                         EAA-283、EAA-286、EAA-287、EAA-287、EAA-289|
| `RouteUID`              | 交通部公共運輸資料開放平台 | HUA0301、HUA0302、HUA0303、HUA0305|
| `RouteName`             | 110traffic.hl.gov.tw       | 301、302、303、305|
| `SubRouteUID`           | motc-ptx.gitbook.io        | HUA030101、HUA030102、HUA030201、HUA030202、HUA030301、HUA030302、HUA0303B1、HUA0303B2、HUA0303C1、HUA0303C2|
| `SubRouteName`          | Gist                       | 301、302、303、303B、303C、303D、305、305A|
| `Direction`             | motc-ptx.gitbook.io        | 0、1 (0去，1回，來源 https://zh.wikipedia.org/zh-tw/太魯閣客運)|
| `FarePricingType`       | ticp.motc.gov.tw           | ODFares (???|
| `StopOrStation`         | Gist                       | 0 (???|
| `BoardingStopUID`       | 110traffic.hl.gov.tw       | HUA290407、HUA290442、HUA290453、HUA290470、HUA290471、HUA290494	、HUA290495、HUA290528、HUA290529、HUA290530|
| `BoardingStopName`      | 110traffic.hl.gov.tw       | 三角市場、上騰高商、中山(市八)市場	、中山三慶豐七街口、中華紙漿、中華路、九曲洞、亞洲水泥廠、仁安社區、信義國小|
| `BoardingStopSequence`  | ticp.motc.gov.tw           | 1、10、11、12、13、14、15、16、17、18 |
| `BoardingTime`          | ticp.motc.gov.tw           | #########################################################################|
| `DeboardingStopUID`     | 110traffic.hl.gov.tw       | -99(逃票)、HUA290407、HUA290442、HUA290452、HUA290470、HUA290471、HUA290494、 HUA290528、HUA290529、HUA290530|
| `DeboardingStopName`    | 110traffic.hl.gov.tw       | -99、三角市場、上騰高商、中山(市八)市場、中山三慶豐七街口、中華紙漿、中華路、九曲洞、亞洲水泥廠、仁安社區 (-99 ???|
| `DeboardingStopSequence`| ticp.motc.gov.tw           | -99、1、10、11、12、13、14、15、16、17 (-99 ???|
| `DeboardingTime`        | ticp.motc.gov.tw           | #########################################################################|
| `Price`                 | 110traffic.hl.gov.tw       | 0、104、106、109、110、12、13、149、15、16|
| `Discount`              | ticp.motc.gov.tw           | 0、12、13、15、16、17、18、19、20、21			|
| `TransferCode`          | ticp.motc.gov.tw           | 0102、0199、0202、0299、0302、0399、0402、0499、0602、0702|
| `DiscountInfo`          | ticp.motc.gov.tw           | ???(第一項變數沒有值)|
| `PaymentPrice`          | 110traffic.hl.gov.tw       | 0、1、10、104、109、11、110、12、13、14|


```{r}
# simple summary for every variables
month.from = 1
month.to = 12
months = generate_months(year.from, year.to, month.from, month.to)
df_summary = data_summary(df)

#df_summary
```

```{r}
# 生成月成長資料
df_grow.month <- list()

for (bus_index in buses) {
  df_grow.month.temp <- data.frame(
    年份 = character(),
    月份 = numeric(),
    成長人數 = numeric(),
    成長百分比 = numeric(),
    stringsAsFactors = FALSE
  )
  
  if (year.from > (year.to - 1)){
    break
  }
  
  for (year in year.from:(year.to - 1)) {
    for (month_index in month.from:month.to) {
      ym_current <- sprintf("%04d%02d", year, month_index)
      ym_next <- sprintf("%04d%02d", year + 1, month_index)
      
      if (!is.null(df[[ym_current]][[bus_index]]) && !is.null(df[[ym_next]][[bus_index]])) {
        a <- nrow(df[[ym_current]][[bus_index]])
        b <- nrow(df[[ym_next]][[bus_index]])
        growth_count <- b - a
        growth_rate <- (b - a) / a

        df_grow.month.temp <- rbind(df_grow.month.temp, data.frame(
          年份 = year + 1,
          月份 = month_index,
          成長人數 = growth_count,
          成長百分比 = round(growth_rate, 2),
          stringsAsFactors = FALSE
        ))
      }
    }
  }
  
  # 儲存到對應 bus 的 list 中
  df_grow.month[[bus_index]] <- df_grow.month.temp
}

df_grow.month[[1]]
```

```{r}
# 生成月平假日成長資料
df_grow.week <- list()

for (bus_index in buses) {
  week_grow_df <- data.frame(
    年份 = character(),
    月份 = numeric(),
    平日或假日 = character(),
    平均成長人數 = numeric(),
    成長百分比 = numeric(),
    stringsAsFactors = FALSE
  )
        
# 平假日名稱
weekday_names <- c("星期一", "星期二", "星期三", "星期四", "星期五")
weekend_names <- c("星期六", "星期日")
  
  for (year in year.from:(year.to - 1)) {
    for (month in month.from:month.to) {
      ym_current <- sprintf("%04d%02d", year, month)
      ym_next <- sprintf("%04d%02d", year + 1, month)
      
      # 檢查該月該車資料是否存在
      if (!is.null(df_summary[[ym_current]][[bus_index]]) && !is.null(df_summary[[ym_next]][[bus_index]])) {
        
        # 取得每月的平假日總人次
        wd_current <- df_summary[[ym_current]][[bus_index]][['Weekday']]
        wd_next <- df_summary[[ym_next]][[bus_index]][['Weekday']]
        
        # 平日與假日人次總和
        total_weekday_current <- sum(wd_current$n[wd_current$Weekday %in% weekday_names])
        total_weekday_next <- sum(wd_next$n[wd_next$Weekday %in% weekday_names])
        total_weekend_current <- sum(wd_current$n[wd_current$Weekday %in% weekend_names])
        total_weekend_next <- sum(wd_next$n[wd_next$Weekday %in% weekend_names])
        
        # 平假日天數
        freq_current <- monthly_weekday_and_weekend(year, month)[['Freq']]
        freq_next <- monthly_weekday_and_weekend(year + 1, month)[['Freq']]
        
        if (length(freq_current) == 2 && length(freq_next) == 2 && freq_next[1] > 0 && freq_next[2] > 0) {
          
          # 平均值
          avg_weekday_current <- total_weekday_current / freq_current[1]
          avg_weekday_next <- total_weekday_next / freq_next[1]
          avg_weekend_current <- total_weekend_current / freq_current[2]
          avg_weekend_next <- total_weekend_next / freq_next[2]
          
          # 成長量與百分比
          growth_weekday <- avg_weekday_next - avg_weekday_current
          growth_rate_weekday <- growth_weekday / avg_weekday_current
          
          growth_weekend <- avg_weekend_next - avg_weekend_current
          growth_rate_weekend <- growth_weekend / avg_weekend_current
          
          # 寫入資料框
          week_grow_df <- rbind(week_grow_df, data.frame(
            年份 = year + 1,
            月份 = month,
            平日或假日 = "平日",
            平均成長人數 = round(growth_weekday, 2),
            成長百分比 = round(growth_rate_weekday, 2),
            stringsAsFactors = FALSE
          ))
          
          week_grow_df <- rbind(week_grow_df, data.frame(
            年份 = year + 1,
            月份 = month,
            平日或假日 = "假日",
            平均成長人數 = round(growth_weekend, 2),
            成長百分比 = round(growth_rate_weekend, 2),
            stringsAsFactors = FALSE
          ))
        }
      }
    }
  }
  
  # 儲存至該 bus_index 的結果
  df_grow.week[[bus_index]] <- week_grow_df
}

df_grow.week[[1]]
```

```{r}
# 定義站點
bus_stops = list()
bus_stops[['301']] = c( "花蓮轉運站",
                        "花蓮電影城",
                        "商校街",
                        "花蓮商校",
                        "郵政總局",
                        "明義國小",
                        "遠東百貨",
                        "花蓮文創園區",
                        "中華路",
                        "東大門夜市",
                        "重慶市場(石藝大街)",
                        "信義國小",
                        "南濱公園",
                        "武聖宮(榮光社區)",
                        "燕聲廣播",
                        "仁安社區",
                        "阿美麻糬",
                        "新天堂樂園",
                        "光華樂活創意園區",
                        "中華紙漿",
                        "大學路口",
                        "東華大學",
                        "行政大樓",
                        "原住民學院",
                        "育成中心",
                        "圖書館資訊大樓"
                      )

bus_stops[['302']] = c( "新城火車站",
                        "立閣文旅",
                        "亞洲水泥廠",
                        "可樂",
                        "富世國小",
                        "太魯閣",
                        "太魯閣國家公園",
                        "砂卡噹",
                        "溪畔",
                        "燕子口",
                        "九曲洞",
                        "合流露營區",
                        "綠水",
                        "天祥"
                      )

bus_stops[['303']] = c( "花蓮轉運站",
                        "市立圖書館",
                        "中山(市八)市場",
                        "明廉國小",
                        "花蓮果菜市場",
                        "中山三慶豐七街口",
                        "好客藝術村",
                        "吉安鄉公所(慶修院)",
                        "上騰高商",
                        "福興",
                        "大陸麵店",
                        "南華國小",
                        "秧悅酒店",
                        "干城",
                        "花蓮監獄",
                        "慕谷慕魚",
                        "文蘭",
                        "鯉魚潭潭北遊客中心",
                        "鯉魚潭潭南遊憩區",
                        "白鮑溪橋",
                        "光榮(壽豐鄉原民館)",
                        "門諾醫院壽豐分院",
                        "豐之谷自然生態公園",
                        "豐坪開發區",
                        "豐坪活動中心",
                        "豐華再現館",
                        "雲山水"
                      )

bus_stops[['305']] = c( "花蓮轉運站",
                        "市立圖書館",
                        "中山(市八)市場",
                        "花蓮後站",
                        "明廉國小",
                        "慈濟醫院",
                        "慈濟大學",
                        "莊敬路",
                        "北昌國小",
                        "建國北昌五街口",
                        "建國路加油站",
                        "三角市場",
                        "碧雲莊",
                        "慈濟科技大學",
                        "水源大橋",
                        "水源村"
                      )

```




















# 畫圖


```{r}
# 運量
volume_plot <- function(bus, year) {
  transport_volume = NULL
  months = generate_months(year, year, month.from, month.to)
  for (month_index in months){
    transport_volume = c(transport_volume, nrow(df[[month_index]][[bus]]))
  }
  
  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = transport_volume,
       type = "o",
       lwd = 2,
       pch = 16,
       col = "gray",
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(transport_volume) * 0.9, max(transport_volume) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線搭乘次數折線圖'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  text(x = month.from:month.to,
       y = transport_volume + max(transport_volume) * 0.02,
       labels = transport_volume,
       pos = 3,            # 文字顯示在點上方
       cex = 1.5,          # 文字大小
       col = "black"
  )
  
  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = paste0(bus, '路線'), 
         col = "gray", 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}

# 全年
month.from = 1
month.to = 12
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    volume_plot(bus, year)
    
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/volume_all.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    volume_plot(bus, year)
    dev.off()
  }
}

# 上半
month.from = 1
month.to = 6
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    volume_plot(bus, year)
    
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/volume_up.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    volume_plot(bus, year)
    dev.off()
  }
}

# 下半
month.from = 7
month.to = 12
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    volume_plot(bus, year)
    
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/volume_down.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    volume_plot(bus, year)
    dev.off()
  }
}
```

```{r}
# TPASS 運量
tpass_volume_plot <- function(bus, year) {
  months = generate_months(year, year, month.from, month.to)
  transport_volume = NULL
  tpass = NULL
  color <- gray.colors(3+1)
  
  for (month_index in months){
    transport_volume = c(transport_volume, nrow(df[[month_index]][[bus]]))
    tpass = c(tpass, sum(df_summary[[month_index]][[bus]][['SubTicketType']][[2]]) - as.data.frame(df_summary[[month_index]][[bus]]$SubTicketType)[[2]][is.na(df_summary[[month_index]][[bus]]$SubTicketType$SubTicketType)]
              )
  }

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = transport_volume,
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(tpass) * 0.9, max(transport_volume) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線搭乘次數折線圖'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  lines(x = month.from:month.to,
        y = tpass,
        type = "o",
        lwd = 2,
        pch = 16,
        col = color[2]
        )
  
  lines(x = month.from:month.to,
        y = transport_volume - tpass,
        type = "o",
        lwd = 2,
        pch = 16,
        col = color[3]
        )
  
  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = c("總運量", "TPASS旅客", "其他旅客"), 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.17, 0),
         xpd = TRUE,
         cex = 1.5
         )
}

# 全年
month.from = 1
month.to = 12
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    tpass_volume_plot(bus, year)
    
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/tpass_volume_all.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    tpass_volume_plot(bus, year)
    dev.off()
  }
}

# 上半
month.from = 1
month.to = 6
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    tpass_volume_plot(bus, year)
    
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/tpass_volume_up.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    tpass_volume_plot(bus, year)
    dev.off()
  }
}

# 下半
month.from = 7
month.to = 12
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    tpass_volume_plot(bus, year)
    
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/tpass_volume_down.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    tpass_volume_plot(bus, year)
    dev.off()
  }
}
```


```{r}
# TPASS 日均運量
tpass_volume_plot <- function(bus, year) {
  months = generate_months(year, year, month.from, month.to)
  transport_volume = NULL
  tpass = NULL
  month.days = NULL
  color <- gray.colors(3+1)
  
  for (month_index in months){
    transport_volume = c(transport_volume, nrow(df[[month_index]][[bus]]))
    tpass = c(tpass, sum(df_summary[[month_index]][[bus]][['SubTicketType']][[2]]) - as.data.frame(df_summary[[month_index]][[bus]]$SubTicketType)[[2]][is.na(df_summary[[month_index]][[bus]]$SubTicketType$SubTicketType)]
              )
  }
  for (month_index in month.from:month.to){
    week.days = monthly_weekday_and_weekend(year = year, month = month_index)[['Freq']]
    month.days = c(month.days, sum(week.days))
  }
  month.volume.per_day = transport_volume / month.days
  tpass.volume.per_day = tpass / month.days
  
  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = month.volume.per_day,
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "日均人次",
       ylim = c(min(tpass.volume.per_day) * 0.9, max(month.volume.per_day) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線日均搭乘次數折線圖'), cex.main = 2, adj = 0)
    
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  lines(x = month.from:month.to,
        y = tpass.volume.per_day,
        type = "o",
        lwd = 2,
        pch = 16,
        col = color[2]
        )
  
  lines(x = month.from:month.to,
        y = month.volume.per_day - tpass.volume.per_day,
        type = "o",
        lwd = 2,
        pch = 16,
        col = color[3]
        )
  
  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = c("月日均", "TPASS旅客", "其他旅客"), 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.17, 0),
         xpd = TRUE,
         cex= 1.5
         )
}

# 全年
month.from = 1
month.to = 12
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    tpass_volume_plot(bus, year)
  
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/tpass_average_volume_all.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    tpass_volume_plot(bus, year)
    dev.off()
  }
}

# 上半
month.from = 1
month.to = 6
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    tpass_volume_plot(bus, year)
  
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/tpass_average_volume_up.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    tpass_volume_plot(bus, year)
    dev.off()
  }
}

# 下半
month.from = 7
month.to = 12
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    tpass_volume_plot(bus, year)
  
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/tpass_average_volume_down.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    tpass_volume_plot(bus, year)
    dev.off()
  }
}
```

```{r}
# 平假日搭乘次數
weekend_and_weekday_volume_plot <- function(bus, year) {
  months = generate_months(year, year, month.from, month.to)
  weekend.days = NULL
  weekday.days = NULL
  month.days = NULL
  weekend.volume = NULL
  weekday.volume = NULL
  month.volume = NULL
  color <- gray.colors(3+1)
  
  for (month_index in month.from:month.to){
    week.days = monthly_weekday_and_weekend(year = year, month = month_index)[['Freq']]
    weekday.days = c(weekday.days, week.days[1])
    weekend.days = c(weekend.days, week.days[2])
    month.days = c(month.days, sum(week.days))
    
    week.volume = df_summary[[sprintf("%04d%02d", year, month_index)]][[bus]][['Weekday']]
    weekday.volume = c(weekday.volume, sum(week.volume$n[week.volume$Weekday %in% c("星期一", "星期二", "星期三", "星期四", "星期五")]))
    weekend.volume = c(weekend.volume, sum(week.volume$n[week.volume$Weekday %in% c("星期六", "星期日")]))
    month.volume = c(month.volume, sum(week.volume$n))
  }
  
  weekday.volume.per_day = weekday.volume / weekday.days
  weekend.volume.per_day = weekend.volume / weekend.days
  month.volume.per_day = month.volume / month.days
  
  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = month.volume.per_day,
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "日均人次",
       ylim = c(min(weekday.volume.per_day, weekend.volume.per_day, month.volume.per_day) * 0.9,
                max(weekday.volume.per_day, weekend.volume.per_day, month.volume.per_day) * 1.1
                ),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線日均搭乘次數折線圖'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  lines(x = month.from:month.to,
        y = weekday.volume.per_day,
        type = "o",
        lwd = 2,
        pch = 16,
        col = color[2]
        )
  
  lines(x = month.from:month.to,
        y = weekend.volume.per_day,
        type = "o",
        lwd = 2,
        pch = 16,
        col = color[3]
        )
  
  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = c("月日均", "平日日均", "假日日均"), 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.16, 0),
         xpd = TRUE,
         cex = 1.5
         )
}

# 全年
month.from = 1
month.to = 12
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    weekend_and_weekday_volume_plot(bus, year)
  
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/weekend_and_weekday_average_volume_all.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    weekend_and_weekday_volume_plot(bus, year)
    dev.off()
  }
}

# 上半
month.from = 1
month.to = 6
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    weekend_and_weekday_volume_plot(bus, year)
  
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/weekend_and_weekday_average_volume_up.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    weekend_and_weekday_volume_plot(bus, year)
    dev.off()
  }
}

# 下半
month.from = 7
month.to = 12
for (year in year.from:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    weekend_and_weekday_volume_plot(bus, year)
  
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/weekend_and_weekday_average_volume_down.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    weekend_and_weekday_volume_plot(bus, year)
    dev.off()
  }
}
```

```{r}
# # 平假日搭乘次數 (ggplot2)
# bus = '301'
# weekend.days = NULL
# weekday.days = NULL
# month.days = NULL
# weekend.volume = NULL
# weekday.volume = NULL
# month.volume = NULL
# 
# for (month_index in month.from:month.to){
#   week.days = monthly_weekday_and_weekend(year = year, month = month_index)[['Freq']]
#   weekday.days = c(weekday.days, week.days[1])
#   weekend.days = c(weekend.days, week.days[2])
#   month.days = c(month.days, sum(week.days))
#   
#   week.volume = df_summary[[sprintf("%04d%02d", year, month_index)]][[bus]][['Weekday']]
#   weekday.volume = c(weekday.volume, sum(week.volume$n[week.volume$Weekday %in% c("星期一", "星期二", "星期三", "星期四", "星期五")]))
#   weekend.volume = c(weekend.volume, sum(week.volume$n[week.volume$Weekday %in% c("星期六", "星期日")]))
#   month.volume = c(month.volume, sum(week.volume$n))
# }
# 
# weekday.volume.per_day = weekday.volume / weekday.days
# weekend.volume.per_day = weekend.volume / weekend.days
# month.volume.per_day = month.volume / month.days
# 
# plot_df <- data.frame(
#   月份 = month.from:month.to,
#   月日均 = month.volume.per_day,
#   平日 = weekday.volume.per_day,
#   假日 = weekend.volume.per_day
# ) %>% pivot_longer(cols = -月份, names_to = "類別", values_to = "人次")
# 
# p <- ggplot(plot_df, aes(x = 月份, y = 人次, color = 類別)) +
#   geom_line(size = 1.2) +
#   geom_point(size = 3) +
#   scale_color_manual(values = c("月日均" = "gray", "平日" = "red", "假日" = "darkgreen")) +
#   labs(
#     x = "月份",
#     y = "日均人次",
#     title = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線日均搭乘次數折線圖'),
#     color = NULL
#   ) +
#   scale_x_continuous(
#     breaks = plot_df$月份
#   ) +
#   scale_y_continuous(
#     breaks = pretty(c(min(plot_df$人次), max(plot_df$人次))),
#     limits = c(min(plot_df$人次), max(plot_df$人次)),
#     expand = expansion(mult = c(0.05, 0.05))
#   ) +
#   theme_minimal(base_family = "kai") +
#   theme(
#     text = element_text(size = 14),
#     plot.title = element_text(hjust = 0.5, face = "bold"),
#     legend.position = "right"
#   )
# 
# print(p)
# 
# # 儲存
# #ggsave("ridership_plot.jpg", plot = p, width = 15, height = 5, dpi = 300)
```

```{r}
# 太魯閣客運單一年總運量
total_volume_plot <- function(buses, year) {
  months = generate_months(year, year, month.from, month.to)
  color <- gray.colors(length(buses)+2)
  
  transport_volume = NULL
  for (bus in buses){
    transport_each_volume = NULL
    for (month_index in months){
      transport_each_volume = c(transport_each_volume, nrow(df[[month_index]][[bus]]))
    }
    transport_volume = c(transport_volume, list(transport_each_volume))
  }
  transport_volume = append(list(Reduce("+", transport_volume)), transport_volume)  # total

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = transport_volume[[1]],
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(sapply(transport_volume, min)) * 0.9 , max(sapply(transport_volume, max)) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月太魯閣客運總運量'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  for(bus_index in 2:(length(buses)+1)){
    lines(x = month.from:month.to,
      y = transport_volume[[bus_index]],
      type = "o",
      lwd = 2,
      pch = 16,
      cex = 1.5,
      col = color[bus_index]
      )
  }

  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = c('總人次', paste0(buses, '路線')), 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}

# 全年
month.from = 1
month.to = 12
for (year in year.from:year.to){
  # 繪圖 (在 R中呈現)
  total_volume_plot(buses, year)
  
  # 儲存圖片
  path = paste0("images/", year - 1911, "/total/line_chart")
  check_path(path)
  png(filename = paste0(path, "/total_volume_all.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  total_volume_plot(buses, year)
  dev.off()
}

# 上半
month.from = 1
month.to = 6
for (year in year.from:year.to){
  # 繪圖 (在 R中呈現)
  total_volume_plot(buses, year)
  
  # 儲存圖片
  path = paste0("images/", year - 1911, "/total/line_chart")
  check_path(path)
  png(filename = paste0(path, "/total_volume_up.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  total_volume_plot(buses, year)
  dev.off()
}

# 下半
month.from = 7
month.to = 12
for (year in year.from:year.to){
  # 繪圖 (在 R中呈現)
  total_volume_plot(buses, year)
  
  # 儲存圖片
  path = paste0("images/", year - 1911, "/total/line_chart")
  check_path(path)
  png(filename = paste0(path, "/total_volume_down.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  total_volume_plot(buses, year)
  dev.off()
}
```


```{r}
# 太魯閣客運多年總運量(月)
month_total_volume_plot <- function(buses, year.from, year.to) {
  years = year.from:year.to
  color <- gray.colors(length(years)+1)
  
  transport_volume_year = list()
  for (year in years) {
    months = generate_months(year, year, month.from, month.to)
    transport_volume = rep(0, length(buses))
    for (bus in buses){
      transport_each_volume = NULL
      for (month_index in months){
        transport_each_volume = c(transport_each_volume, nrow(df[[month_index]][[bus]]))
      }
      transport_volume = transport_volume + transport_each_volume
    }
    transport_volume_year[[as.character(year)]] = transport_volume  # total
  }

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = transport_volume_year[[1]],
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(sapply(transport_volume_year, min)) * 0.9 , max(sapply(transport_volume_year, max)) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )

  title(main = paste0(year.from - 1911, '年', '至', year.to - 1911, '年太魯閣客運月總運量'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  for(year_index in 2:(length(years))){
    lines(x = month.from:month.to,
          y = transport_volume_year[[year_index]],
          type = "o",
          lwd = 2,
          pch = 16,
          cex = 1.5,
          col = color[year_index]
          )
  }   

  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = paste0(years - 1911, '年'), 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}


# 全年
month.from = 1
month.to = 12

# 繪圖 (在 R中呈現)
month_total_volume_plot(buses, year.from, year.to)

# 儲存圖片
path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/total/line_chart")
check_path(path)
png(filename = paste0(path, "/month_total_volume_all.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
month_total_volume_plot(buses, year.from, year.to)
dev.off()


# 上半
month.from = 1
month.to = 6

# 繪圖 (在 R中呈現)
month_total_volume_plot(buses, year.from, year.to)

# 儲存圖片
path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/total/line_chart")
check_path(path)
png(filename = paste0(path, "/month_total_volume_up.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
month_total_volume_plot(buses, year.from, year.to)
dev.off()


# 下半
month.from = 7
month.to = 12

# 繪圖 (在 R中呈現)
month_total_volume_plot(buses, year.from, year.to)

# 儲存圖片
path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/total/line_chart")
check_path(path)
png(filename = paste0(path, "/month_total_volume_down.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
month_total_volume_plot(buses, year.from, year.to)
dev.off()



```

```{r}
# 太魯閣客運多年總運量(年)
year_total_volume_plot <- function(buses, year.from, year.to) {
  years = year.from:year.to
  color <- gray.colors(2)
  
  transport_volume_year <- sapply(years, function(year) {
    months <- generate_months(year, year, month.from, month.to)
    sum(sapply(buses, function(bus) {
      sum(sapply(months, function(month_index) {
        nrow(df[[month_index]][[bus]])
      }))
    }))
  }) %>% c()
  
  print(transport_volume_year)

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = years,
       y = transport_volume_year,
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "年",
       ylab = "搭乘次數",
       ylim = c(min(sapply(transport_volume_year, min)) * 0.9 , max(sapply(transport_volume_year, max)) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year.from - 1911, '年', '至', year.to - 1911, '年太魯閣客運年總運量'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = years, labels = c(years - 1911), cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)

  grid()  # 網格線
  
  text(x = years,
       y = transport_volume_year + max(transport_volume_year) * 0.02,
       labels = transport_volume_year,
       pos = 3,            # 文字顯示在點上方
       cex = 1.5,          # 文字大小
       col = "black"
  )
  
  # 圖例
  legend("topright", 
         legend = "總運量", 
         col = color[1], 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}


# 繪圖 (在 R中呈現)
year_total_volume_plot(buses, year.from, year.to)

# 儲存圖片
path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/total/line_chart")
check_path(path)
png(filename = paste0(path, "/year_total_volume.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
year_total_volume_plot(buses, year.from, year.to)
dev.off()

```

```{r}
# 太魯閣客運多年總運量
volume_by_bus_plot <- function(bus, year.from, year.to) {
  years = year.from:year.to
  color <- gray.colors(length(years)+1)
  
  transport_volume_year = list()
  for (year in years) {
    months = generate_months(year, year, month.from, month.to)
    transport_each_volume = NULL
    for (month_index in months){
      transport_each_volume = c(transport_each_volume, nrow(df[[month_index]][[bus]]))
    }
    transport_volume_year[[as.character(year)]] = transport_each_volume  # total
  }
  

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = transport_volume_year[[1]],
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(sapply(transport_volume_year, min)) * 0.9 , max(sapply(transport_volume_year, max)) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year.from - 1911, '年', '至', year.to - 1911, '年', month.from, '月至', month.to, '月', bus, '路線月運量'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  for(year_index in 2:(length(years))){
    lines(x = month.from:month.to,
          y = transport_volume_year[[year_index]],
          type = "o",
          lwd = 2,
          pch = 16,
          cex = 1.5,
          col = color[year_index]
          )
  }   

  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = paste0(years - 1911, '年'), 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}


# 全年
month.from = 1
month.to = 12

for(bus in buses){
  # 繪圖 (在 R中呈現)
  volume_by_bus_plot(bus, year.from, year.to)
  
  # 儲存圖片
  path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/", bus, "/line_chart")
  check_path(path)
  png(filename = paste0(path, "/volume_all.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  volume_by_bus_plot(bus, year.from, year.to)
  dev.off()
}


# 上半
month.from = 1
month.to = 6

for(bus in buses){
  # 繪圖 (在 R中呈現)
  volume_by_bus_plot(bus, year.from, year.to)
  
  # 儲存圖片
  path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/", bus, "/line_chart")
  check_path(path)
  png(filename = paste0(path, "/volume_up.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  volume_by_bus_plot(bus, year.from, year.to)
  dev.off()
}


# 下半
month.from = 7
month.to = 12

for(bus in buses){
  # 繪圖 (在 R中呈現)
  volume_by_bus_plot(bus, year.from, year.to)
  
  # 儲存圖片
  path = paste0("images/from_", year.from - 1911, "_to_", year.to - 1911, "/", bus, "/line_chart")
  check_path(path)
  png(filename = paste0(path, "/volume_down.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  volume_by_bus_plot(bus, year.from, year.to)
  dev.off()
}
```


```{r}
# 月增長量
monthly_gorw_up_plot <- function(bus, year) {
  color <- "gray"
  
  df_grow_year = df_grow.month[[bus]] %>% filter(年份 == year & 月份 %in% month.from:month.to)
  df_grow_year <- df_grow_year$成長人數

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = df_grow_year,
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "成長人數",
       ylim = c(min(df_grow_year) * ifelse(min(df_grow_year) > 0, 0.9, 1.1) , max(df_grow_year) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year - 1 - 1911, '、', year - 1911, '年', bus, '路線運量消長情形同期比較'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)

  grid()  # 網格線
  
  text(x = month.from:month.to,
       y = df_grow_year + max(df_grow_year) * 0.01,
       labels = df_grow_year,
       pos = 3,            # 文字顯示在點上方
       cex = 1.5,          # 文字大小
       col = "black"
  )
  
  # 圖例
  legend("topright", 
         legend = '增長量', 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}


# 全年
month.from = 1
month.to = 12
for(bus in buses){
  for (year in (year.from + 1):year.to){
    # 繪圖 (在 R中呈現)
    monthly_gorw_up_plot(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/month_grow_up_all.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    monthly_gorw_up_plot(bus, year)
    dev.off()
  }
}


# 上半
month.from = 1
month.to = 6
for(bus in buses){
  for (year in (year.from + 1):year.to){
    # 繪圖 (在 R中呈現)
    monthly_gorw_up_plot(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/month_grow_up_up.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    monthly_gorw_up_plot(bus, year)
    dev.off()
  }
}


# 下半
month.from = 7
month.to = 12
for(bus in buses){
  for (year in (year.from + 1):year.to){
    # 繪圖 (在 R中呈現)
    monthly_gorw_up_plot(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/month_grow_up_down.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    monthly_gorw_up_plot(bus, year)
    dev.off()
  }
}
```

```{r}
# 月平假日增長量
weekday_and_weekend_gorw_up_plot <- function(bus, year) {
  color <- gray.colors(3)
  
  df_grow_year = df_grow.week[[bus]] %>%  filter(年份 == year & 月份 %in% month.from:month.to)
  df_grow_weekday <- (df_grow_year %>% filter(平日或假日 == '平日'))$平均成長人數
  df_grow_weekend <- (df_grow_year %>% filter(平日或假日 == '假日'))$平均成長人數

  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = month.from:month.to,
       y = df_grow_weekday,
       type = "o",
       lwd = 2,
       pch = 16,
       col = color[1],
       xlab = "月份",
       ylab = "成長人數",
       ylim = c(min(df_grow_year$平均成長人數) * ifelse(min(df_grow_year$平均成長人數) > 0, 0.9, 1.1) , max(df_grow_year$平均成長人數) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  
  title(main = paste0(year - 1 - 1911, '、', year - 1911, '年', bus, '路線平假日日均次數消長情形'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = month.from:month.to, labels = month.from:month.to, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  lines(x = month.from:month.to,
        y = df_grow_weekend,
        type = "o",
        lwd = 2,
        pch = 16,
        cex = 1.5,
        col = color[2]
        )

  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = c('平日', '假日'), 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}


# 全年
month.from = 1
month.to = 12
for(bus in buses){
  for (year in (year.from + 1):year.to){
    # 繪圖 (在 R中呈現)
    weekday_and_weekend_gorw_up_plot(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/week_grow_up_all.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    weekday_and_weekend_gorw_up_plot(bus, year)
    dev.off()
  }
}


# 上半
month.from = 1
month.to = 6
for(bus in buses){
  for (year in (year.from + 1):year.to){
    # 繪圖 (在 R中呈現)
    weekday_and_weekend_gorw_up_plot(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/week_grow_up_up.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    weekday_and_weekend_gorw_up_plot(bus, year)
    dev.off()
  }
}


# 下半
month.from = 7
month.to = 12
for(bus in buses){
  for (year in (year.from + 1):year.to){
    # 繪圖 (在 R中呈現)
    weekday_and_weekend_gorw_up_plot(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/week_grow_up_down.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    weekday_and_weekend_gorw_up_plot(bus, year)
    dev.off()
  }
}
```

```{r}
# 路線搭車票種長條圖
tick_type_histgram <- function(bus, year) {
  months = generate_months(year, year, month.from, month.to)
  
  df_ticket = data.frame()
  for(month_index in months){
    df_ticket = rbind(df_ticket, df[[month_index]][[bus]])
  }

  df_ticket <- convert_holder_type(df_ticket$HolderType) %>% table()
  color <- gray.colors(length(df_ticket))
  
  par(family = "kai", mar = c(5, 6, 4, 3))  # 字體與圖寬
  
  bp <- barplot(height = df_ticket,
                col = color,
                xlab = "票種",
                ylab = "數量",
                las = 1,
                cex.main = 2,
                cex.lab = 2,
                cex.axis = 1.5,
                cex = 1.5,
                yaxt = "n",
                main = "",
                ylim = c(0, max(df_ticket) * 1.1)
                )

  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線搭車票種'), cex.main = 2, adj = 0)
  
  # x 軸
  #axis(side = 1, at = 1:length(df_ticket), labels = c(names(df_ticket)), cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  # 百分比
  labels <- paste0(round(df_ticket * 100 / sum(df_ticket)), "%")
  
  text(x = bp, 
       y = df_ticket, 
       labels = labels, 
       pos = 3,
       cex = 1.5)
  
}


# 全年
month.from = 1
month.to = 12
for(bus in buses){
  for (year in year.from:year.to){
    # 繪圖 (在 R中呈現)
    tick_type_histgram(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/barplot")
    check_path(path)
    png(filename = paste0(path, "/路線搭車票種_all.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
    tick_type_histgram(bus, year)
    dev.off()
  }
}


# 上半
month.from = 1
month.to = 6
for(bus in buses){
  for (year in year.from:year.to){
    # 繪圖 (在 R中呈現)
    tick_type_histgram(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/barplot")
    check_path(path)
    png(filename = paste0(path, "/路線搭車票種_up.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
    tick_type_histgram(bus, year)
    dev.off()
  }
}


# 下半
month.from = 7
month.to = 12
for(bus in buses){
  for (year in year.from:year.to){
    # 繪圖 (在 R中呈現)
    tick_type_histgram(bus, year)
    
    # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/barplot")
    check_path(path)
    png(filename = paste0(path, "/路線搭車票種_down.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
    tick_type_histgram(bus, year)
    dev.off()
  }
}
```


```{r}
# 路線搭車票種長條圖 (去程，direction = 0; 回程，direction = 1)
tick_type_direction_histgram <- function(bus, year, direction) {
  months = generate_months(year, year, month.from, month.to)
  
  df_ticket = data.frame()
  for(month_index in months){
    df_ticket = rbind(df_ticket, df[[month_index]][[bus]][ df[[month_index]][[bus]][["Direction"]] == direction, ])
  }
  
  df_ticket <- convert_holder_type(df_ticket$HolderType) %>% table()
  color <- gray.colors(length(df_ticket))
  
  par(family = "kai", mar = c(5, 6, 4, 3))  # 字體與圖寬
  
  bp <- barplot(height = df_ticket,
                col = color,
                xlab = "票種",
                ylab = "數量",
                las = 1,
                cex.main = 2,
                cex.lab = 2,
                cex.axis = 1.5,
                cex = 1.5,
                yaxt = "n",
                main = "",
                ylim = c(0, max(df_ticket) * 1.1)
                )

  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線', ifelse(direction == 0, '去程', '回程'), '搭車票種'), cex.main = 2, adj = 0)
  
  # x 軸
  #axis(side = 1, at = 1:length(df_ticket), labels = c(names(df_ticket)), cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  # 百分比
  labels <- paste0(round(df_ticket * 100 / sum(df_ticket)), "%")
  
  text(x = bp, 
       y = df_ticket, 
       labels = labels, 
       pos = 3,
       cex = 1.5)
  
}


# 全年
month.from = 1
month.to = 12
for (direction in 0:1){
  for(bus in buses){
    for (year in year.from:year.to){
      # 繪圖 (在 R中呈現)
      tick_type_direction_histgram(bus, year, direction)
      
      # 儲存圖片
      path = paste0("images/", year - 1911, "/", bus, "/barplot")
      check_path(path)
      png(filename = paste0(path, "/路線", ifelse(direction == 0, '去程', '回程'), "搭車票種_all.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
      tick_type_direction_histgram(bus, year, direction)
      dev.off()
    }
  }
}



# 上半
month.from = 1
month.to = 6
for (direction in 0:1){
  for(bus in buses){
    for (year in year.from:year.to){
      # 繪圖 (在 R中呈現)
      tick_type_direction_histgram(bus, year, direction)
      
      # 儲存圖片
      path = paste0("images/", year - 1911, "/", bus, "/barplot")
      check_path(path)
      png(filename = paste0(path, "/路線", ifelse(direction == 0, '去程', '回程'), "搭車票種_up.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
      tick_type_direction_histgram(bus, year, direction)
      dev.off()
    }
  }
}


# 下半
month.from = 7
month.to = 12
for (direction in 0:1){
  for(bus in buses){
    for (year in year.from:year.to){
      # 繪圖 (在 R中呈現)
      tick_type_direction_histgram(bus, year, direction)
      
      # 儲存圖片
      path = paste0("images/", year - 1911, "/", bus, "/barplot")
      check_path(path)
      png(filename = paste0(path, "/路線", ifelse(direction == 0, '去程', '回程'), "搭車票種_down.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
      tick_type_direction_histgram(bus, year, direction)
      dev.off()
    }
  }
}
```

```{r}
# 平假日路線各上下車站點票種直方疊圖 (去程，direction = 0; 回程，direction = 1)
tick_type_week_day_direction_histgram <- function(bus, year, week_day, direction, boarding) {
  months = generate_months(year, year, month.from, month.to)
  if (week_day == '平日'){
    weekday = c("星期一", "星期二", "星期三", "星期四", "星期五")
  } else {
    weekday = c("星期六", "星期日")
  }
  df_ticket <- data.frame()
  for (month_index in months) {
    df_month <- df[[month_index]][[bus]]
    df_month <- df_month[df_month$Direction == direction, ]
    df_ticket <- rbind(df_ticket, df_month)
  }

  df_ticket <- df_ticket[df_ticket$Weekday %in% weekday, ]  # 抓取平假日 
  if (boarding){
    df_ticket <- df_ticket[df_ticket$BoardingStopName != "-99", ]  #移除逃票
    table_limit <- max(table(df_ticket$BoardingStopName))
  }else {
    df_ticket <- df_ticket[df_ticket$DeboardingStopName != "-99", ]  #移除逃票
    table_limit <- max(table(df_ticket$DeboardingStopName))
  }
    
  df_ticket$HolderType <- convert_holder_type(df_ticket$HolderType)

  # 依照站別順序
  if (boarding){
    df_ticket$BoardingStopSequence <- as.numeric(df_ticket$BoardingStopSequence)
    stop_order <- df_ticket[!duplicated(df_ticket$BoardingStopName), c("BoardingStopName", "BoardingStopSequence")]
    stop_order <- stop_order[order(stop_order$BoardingStopSequence), ]
  }else {
    df_ticket$DeboardingStopSequence <- as.numeric(df_ticket$DeboardingStopSequence)
    stop_order <- df_ticket[!duplicated(df_ticket$DeboardingStopName), c("DeboardingStopName", "DeboardingStopSequence")]
    stop_order <- stop_order[order(stop_order$DeboardingStopSequence), ]
  }

  # 製作疊圖
  if (boarding){
    ticket_count <- table(df_ticket$HolderType, df_ticket$BoardingStopName)
    ticket_count <- ticket_count[, stop_order$BoardingStopName]
  }else {
    ticket_count <- table(df_ticket$HolderType, df_ticket$DeboardingStopName)
    ticket_count <- ticket_count[, stop_order$DeboardingStopName]
  }
  color <- gray.colors(nrow(ticket_count))
  #color <- rainbow(nrow(ticket_count))
  
  par(family = "kai", mar = c(5, 13, 2, 6))  # 字體與圖寬 c(bottom, left, top, right)
  
  barplot(height = ticket_count,
          col = color,
          xlab = "票種疊圖",
          #ylab = "站別",
          las = 1,
          horiz = TRUE,
          cex.main = 2,
          cex.lab = 2,
          cex.axis = 1.5,
          cex = 1.5,
          #yaxt = "n",
          main = "",
          xlim = c(0, table_limit * 1.1)
          )

  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線', ifelse(direction == 0, '去程', '回程'), ifelse(week_day == '平日', '平日', '假日'), '各', ifelse(boarding, '上', '下'), '車站點票種直方疊圖'), cex.main = 2, adj = 0)
  
  # x 軸
  #axis(side = 1, at = 1:length(ticket_count), labels = c(names(ticket_count)), cex.axis = 1.5)
  
  # y 軸
  #axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
    # 圖例
  legend("topright", 
         legend = rownames(ticket_count), 
         fill =  color, 
         title = "票種",
         cex = 1.5
         )

}


# 全年
month.from = 1
month.to = 12
for(boarding in c(TRUE, FALSE)){
  for (week_day in c('平日', '假日')){
    for (direction in 0:1){
      for(bus in buses){
        for (year in year.from:year.to){
          # 繪圖 (在 R中呈現)
          tick_type_week_day_direction_histgram(bus, year, week_day, direction, boarding)
          
          # 儲存圖片
          path = paste0("images/", year - 1911, "/", bus, "/barplot")
          check_path(path)
          png(filename = paste0(path, "/路線", ifelse(direction == 0, '去程', '回程'), ifelse(week_day == '平日', '平日', '假日'),  "各", ifelse(boarding, '上', '下'), "車站點票種直方疊圖_all.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
          tick_type_week_day_direction_histgram(bus, year, week_day, direction, boarding)
          dev.off()
        }
      }
    }
  }
}


# 上半
month.from = 1
month.to = 6
for(boarding in c(TRUE, FALSE)){
  for (week_day in c('平日', '假日')){
    for (direction in 0:1){
      for(bus in buses){
        for (year in year.from:year.to){
          # 繪圖 (在 R中呈現)
          tick_type_week_day_direction_histgram(bus, year, week_day, direction, boarding)
          
          # 儲存圖片
          path = paste0("images/", year - 1911, "/", bus, "/barplot")
          check_path(path)
          png(filename = paste0(path, "/路線", ifelse(direction == 0, '去程', '回程'), ifelse(week_day == '平日', '平日', '假日'),  "各", ifelse(boarding, '上', '下'), "車站點票種直方疊圖_up.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
          tick_type_week_day_direction_histgram(bus, year, week_day, direction, boarding)
          dev.off()
        }
      }
    }
  }
}


# 下半
month.from = 7
month.to = 12
for(boarding in c(TRUE, FALSE)){
  for (week_day in c('平日', '假日')){
    for (direction in 0:1){
      for(bus in buses){
        for (year in year.from:year.to){
          # 繪圖 (在 R中呈現)
          tick_type_week_day_direction_histgram(bus, year, week_day, direction, boarding)
          
          # 儲存圖片
          path = paste0("images/", year - 1911, "/", bus, "/barplot")
          check_path(path)
          png(filename = paste0(path, "/路線", ifelse(direction == 0, '去程', '回程'), ifelse(week_day == '平日', '平日', '假日'),  "各", ifelse(boarding, '上', '下'), "車站點票種直方疊圖_down.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
          tick_type_week_day_direction_histgram(bus, year, week_day, direction, boarding)
          dev.off()
        }
      }
    }
  }
}
```


```{r}
# 乘坐分鐘票種點圖
boarding_time_direction_plot <- function(bus, year, direction) {
  months = generate_months(year, year, month.from, month.to)
  
  df_ticket = data.frame()
  for(month_index in months){
    df_ticket = rbind(df_ticket, df[[month_index]][[bus]][ df[[month_index]][[bus]][["Direction"]] == direction, ])
  }
  
  # 將 HolderType 和 TravelTime 是 NA 的資料移除
  df_ticket = df_ticket[!is.na(df_ticket$HolderType), ]
  df_ticket = df_ticket[!is.na(df_ticket$TravelTime), ]
  
  df_ticket$BoardingStopSequence = as.numeric(df_ticket$BoardingStopSequence)
  
  holder_types <- convert_holder_type(df_ticket$HolderType) %>% unique()
  color <- setNames(rainbow(length(holder_types)), holder_types)
  df_ticket$Color <- color[convert_holder_type(df_ticket$HolderType)]
  
  par(family = "kai", mar = c(14, 6, 4, 10))  # 字體與圖寬
  
  plot(x = df_ticket$BoardingStopSequence,
       y = df_ticket$TravelTime,
       col = df_ticket$Color,
       xlab = "",
       ylab = "乘車分鐘",
       pch = 16,
       las = 1,
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       #yaxt = "n",
       main = "",
       bty = "n"
       )

  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線(', ifelse(direction == 0, '去程', '回程'), ')上車站點-乘坐分鐘票種點圖'), cex.main = 2, adj = 0)
  
  # x 軸
  labels_to_use <- if (direction == 0) {
    bus_stops[[bus]]
  } else {
    rev(bus_stops[[bus]])
  }
  
  axis(side = 1,
       las = 2,
       at = 1:length(bus_stops[[bus]]),
       labels =  labels_to_use,
       cex.axis = 1.2
       )
  mtext("上車站點", side = 1, line = 12, cex = 2)
  
  # y 軸
  #axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  # 圖例
  legend("topright", 
         legend = holder_types, 
         col = color, 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}


# 全年
month.from = 1
month.to = 12
for (direction in 0:1){
  for(bus in buses){
    for (year in year.from:year.to){
      # 繪圖 (在 R中呈現)
      boarding_time_direction_plot(bus, year, direction)
      
      # 儲存圖片
      path = paste0("images/", year - 1911, "/", bus, "/scatter plot")
      check_path(path)
      png(filename = paste0(path, "/路線(", ifelse(direction == 0, '去程', '回程'), ")上車站點-乘坐分鐘票種點圖_all.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
      boarding_time_direction_plot(bus, year, direction)
      dev.off()
    }
  }
}



# 上半
month.from = 1
month.to = 6
for (direction in 0:1){
  for(bus in buses){
    for (year in year.from:year.to){
      # 繪圖 (在 R中呈現)
      boarding_time_direction_plot(bus, year, direction)
      
      # 儲存圖片
      path = paste0("images/", year - 1911, "/", bus, "/scatter plot")
      check_path(path)
      png(filename = paste0(path, "/路線(", ifelse(direction == 0, '去程', '回程'), ")上車站點-乘坐分鐘票種點圖_up.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
      boarding_time_direction_plot(bus, year, direction)
      dev.off()
    }
  }
}


# 下半
month.from = 7
month.to = 12
for (direction in 0:1){
  for(bus in buses){
    for (year in year.from:year.to){
      # 繪圖 (在 R中呈現)
      boarding_time_direction_plot(bus, year, direction)
      
      # 儲存圖片
      path = paste0("images/", year - 1911, "/", bus, "/scatter plot")
      check_path(path)
      png(filename = paste0(path, "/路線(", ifelse(direction == 0, '去程', '回程'), ")上車站點-乘坐分鐘票種點圖_down.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
      boarding_time_direction_plot(bus, year, direction)
      dev.off()
    }
  }
}
```


```{r}
# 乘坐分鐘盒狀圖
travel_time_direction_boxplot <- function(bus, year, direction) {
  months = generate_months(year, year, month.from, month.to)
  
  df_ticket = data.frame()
  for(month_index in months){
    df_ticket = rbind(df_ticket, df[[month_index]][[bus]][ df[[month_index]][[bus]][["Direction"]] == direction, ])
  }
  
  # 將 HolderType 和 TravelTime 是 NA 的資料移除
  df_ticket = df_ticket[!is.na(df_ticket$BoardingStopName), ]
  df_ticket = df_ticket[!is.na(df_ticket$TravelTime), ]
  
  # 站點順序
  df_ticket$BoardingStopSequence = as.numeric(df_ticket$BoardingStopSequence)
  stop_order = df_ticket[!duplicated(df_ticket$BoardingStopName), c("BoardingStopName", "BoardingStopSequence")]
  stop_order = stop_order[order(stop_order$BoardingStopSequence), ]
  df_ticket$BoardingStopName = factor(df_ticket$BoardingStopName, levels = stop_order$BoardingStopName)
  
  par(family = "kai", mar = c(5, 13, 3, 2))  # 字體與圖寬 c(bottom, left, top, right)
  
  boxplot(split(df_ticket$TravelTime, df_ticket$BoardingStopName),
          horizontal = TRUE,
          xlab = "乘車分鐘",
          #ylab = "站點",
          las = 1,
          cex.main = 2,
          cex.lab = 2,
          cex.axis = 1.5,
          cex = 1.5,
          main = "",
          bty = "n",
          names = levels(df_ticket$BoardingStopName),
          frame.plot = FALSE
  )

  title(main = paste0(year - 1911, '年', month.from, '月至', month.to, '月', bus, '路線(', ifelse(direction == 0, '去程', '回程'), ')上車站點-乘坐分鐘盒狀圖'), cex.main = 2, adj = 0)
}


# 全年
month.from = 1
month.to = 12
for (direction in 0:1){
  for(bus in buses){
    for (year in year.from:year.to){
      # 繪圖 (在 R中呈現)
      travel_time_direction_boxplot(bus, year, direction)
      
      # 儲存圖片
      path = paste0("images/", year - 1911, "/", bus, "/boxplot")
      check_path(path)
      png(filename = paste0(path, "/路線(", ifelse(direction == 0, '去程', '回程'), ")上車站點-乘坐分鐘盒狀圖_all.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
      travel_time_direction_boxplot(bus, year, direction)
      dev.off()
    }
  }
}



# 上半
month.from = 1
month.to = 6
for (direction in 0:1){
  for(bus in buses){
    for (year in year.from:year.to){
      # 繪圖 (在 R中呈現)
      travel_time_direction_boxplot(bus, year, direction)
      
      # 儲存圖片
      path = paste0("images/", year - 1911, "/", bus, "/boxplot")
      check_path(path)
      png(filename = paste0(path, "/路線(", ifelse(direction == 0, '去程', '回程'), ")上車站點-乘坐分鐘盒狀圖_up.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
      travel_time_direction_boxplot(bus, year, direction)
      dev.off()
    }
  }
}


# 下半
month.from = 7
month.to = 12
for (direction in 0:1){
  for(bus in buses){
    for (year in year.from:year.to){
      # 繪圖 (在 R中呈現)
      travel_time_direction_boxplot(bus, year, direction)
      
      # 儲存圖片
      path = paste0("images/", year - 1911, "/", bus, "/boxplot")
      check_path(path)
      png(filename = paste0(path, "/路線(", ifelse(direction == 0, '去程', '回程'), ")上車站點-乘坐分鐘盒狀圖_down.png"), width = 13.79, height = 8.25, units = "in", res = 300, family = "kai")
      travel_time_direction_boxplot(bus, year, direction)
      dev.off()
    }
  }
}
```



```{r}
# 個別TPASS運量
tpass_plot <- function(bus, year.to) {
  months = c("202310", "202311", "202312", generate_months(2024, year.to, 1, 12))
  x_dates <- as.Date(paste0(months, "01"), format = "%Y%m%d")

  tpass = NULL
  for(month_index in months){
    tpass = c(tpass, sum(df_summary[[month_index]][[bus]][['SubTicketType']][[2]]) 
              - as.data.frame(df_summary[[month_index]][[bus]]$SubTicketType)[[2]][is.na(df_summary[[month_index]][[bus]]$SubTicketType$SubTicketType)]
              )
  }
  
  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = x_dates,
       y = tpass,
       type = "o",
       lwd = 2,
       pch = 16,
       col = "gray",
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(tpass) * 0.9, max(tpass) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  months = as.character(as.numeric(months) - 191100)
  title(main = paste0('112年10月至', year.to - 1911, '年12月', bus, '路線TPASS搭乘次數折線圖'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = x_dates, labels = months, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  text(x = x_dates,
       y = tpass + max(tpass) * 0.02,
       labels = tpass,
       pos = 3,            # 文字顯示在點上方
       cex = 1.5,          # 文字大小
       col = "black"
  )
  
  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = paste0(bus, '路線'), 
         col = "gray", 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}

# 畫到至今為止的圖
for (year in 2024:year.to){
  for (bus in buses){
  
  # 繪圖 (在 R中呈現)
    tpass_plot(bus, year)
    
  # 儲存圖片
    path = paste0("images/", year - 1911, "/", bus, "/line_chart")
    check_path(path)
    png(filename = paste0(path, "/tpass.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
    tpass_plot(bus, year)
    dev.off()
  }
}
```

```{r}
# 個別TPASS運量
tpass_total_plot <- function(year.to) {
  months = c("202310", "202311", "202312", generate_months(2024, year.to, 1, 12))
  x_dates <- as.Date(paste0(months, "01"), format = "%Y%m%d")

  tpass_total = data.frame()
  for(bus in buses){
    tpass = NULL
    for(month_index in months){
      tpass = c(tpass, sum(df_summary[[month_index]][[bus]][['SubTicketType']][[2]]) 
                - as.data.frame(df_summary[[month_index]][[bus]]$SubTicketType)[[2]][is.na(df_summary[[month_index]][[bus]]$SubTicketType$SubTicketType)]
                )
    }
    tpass_total = rbind(tpass_total, tpass)
  }
  tpass_total = unname(apply(tpass_total, 2, sum))
  
  par(family = "kai", mar = c(5, 6, 4, 10))  # 字體與圖寬
  
  plot(x = x_dates,
       y = tpass_total,
       type = "o",
       lwd = 2,
       pch = 16,
       col = "gray",
       xlab = "月份",
       ylab = "搭乘次數",
       ylim = c(min(tpass_total) * 0.9, max(tpass_total) * 1.1),
       cex.main = 2,
       cex.lab = 2,
       cex.axis = 1.5,
       cex = 1.5,
       xaxt = "n",
       yaxt = "n",
       bty = "n"
       )
  months = as.character(as.numeric(months) - 191100)
  title(main = paste0('112年10月至', year.to - 1911, '年12月太魯閣客運TPASS搭乘次數折線圖'), cex.main = 2, adj = 0)
  
  # x 軸
  axis(side = 1, at = x_dates, labels = months, cex.axis = 1.5)
  
  # y 軸
  axis(side = 2, las = 1, cex.axis = 1.5, line = -1.5)
  
  text(x = x_dates,
       y = tpass_total + max(tpass_total) * 0.02,
       labels = tpass_total,
       pos = 3,            # 文字顯示在點上方
       cex = 1.5,          # 文字大小
       col = "black"
  )
  
  grid()  # 網格線
  
  # 圖例
  legend("topright", 
         legend = "總人次", 
         col = "gray", 
         lwd = 2, 
         pch = 16,
         bty = "n",
         inset = c(-0.15, 0),
         xpd = TRUE,
         cex = 1.5
         )
}

# 畫到至今為止的圖
for (year in 2024:year.to){
# 繪圖 (在 R中呈現)
  tpass_total_plot(year)
  
# 儲存圖片
  path = paste0("images/", year - 1911, "/total/line_chart")
  check_path(path)
  png(filename = paste0(path, "/tpass_total.png"), width = 15, height = 5, units = "in", res = 300, family = "kai")
  tpass_total_plot(year)
  dev.off()
}
```




```{r}
# tpass for earlist passenger
months = generate_months(2023, year.to, 1, 12)
  
tpass = data.frame()
for(bus in buses){
  tpass_bus = data.frame()
  for(month_index in months){
    tpass_bus = rbind(tpass_bus, df[[month_index]][[bus]])
  }
  
  tpass_bus = tpass_bus[!is.na(tpass_bus$SubTicketType), ]
  tpass_bus$BoardingTime = ymd_hms(tpass_bus$BoardingTime)
  
  print(paste0('earlist TPASS for ', bus, ' is: '))
  print(tpass_bus[which.min(tpass_bus$BoardingTime), ])
  tpass = rbind(tpass, tpass_bus)
}
earliest_row = tpass[which.min(tpass$BoardingTime), ]
print('first TPASS for all roads: ')
print(earliest_row)

```


```{r}
end_time = Sys.time()

print(paste0('Cost time: ', end_time - start_time, ' minutes'))
```

































